/**
 * PDA DEDRA v3.0.4 – BACKEND z OBSŁUGĄ KOLORÓW + GAZETKA
 * Arkusz źródłowy: 1YMbYxaMLcinjb6yOIS_qx8KPiPZESr9HfEAscFtRIM8
 * 
 * ZMIANY w 3.0.4:
 * - Dodano obsługę kolumny "GAZETKA" dla produktów i zestawów
 * - System rozpoznaje: NEW, PROMO, GAZETKA
 */

const SS_ID = '1YMbYxaMLcinjb6yOIS_qx8KPiPZESr9HfEAscFtRIM8';
const TZ = Session.getScriptTimeZone() || 'Europe/Warsaw';

// === ROUTING: HTML lub API ===
function doGet(e) {
  // Jeśli brak parametrów action -> zwracamy HTML
  if (!e || !e.parameter || !e.parameter.action) {
    return HtmlService.createHtmlOutputFromFile('index')
      .setTitle('PDA DEDRA v3.0.4')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  }

  // API mode
  const action = e.parameter.action;
  try {
    if (action === 'getHandlowcy') {
      return jsonResponse(getHandlowcy());
    }
    if (action === 'getProducts') {
      return jsonResponse(getProdukty());
    }
    if (action === 'getPOS') {
      return jsonResponse(getPOS());
    }
    if (action === 'getZestawy') {
      return jsonResponse(getZestawy());
    }
    if (action === 'wyslijZamowienie') {
      const userName = e.parameter.userName || '';
      const userEmail = e.parameter.userEmail || '';
      const cartStr = e.parameter.cart || '[]';
      const sklep = e.parameter.sklep || '';
      const promo = e.parameter.promo || '';

      // DEBUGOWANIE: loguj co przychodzi z frontendu
      Logger.log('=== OTRZYMANO REQUEST ===');
      Logger.log('userName: ' + userName);
      Logger.log('userEmail: ' + userEmail);
      Logger.log('sklep: ' + sklep);
      Logger.log('promo: ' + promo);
      Logger.log('cartStr length: ' + cartStr.length);

      let cart = [];
      try {
        cart = JSON.parse(cartStr);
      } catch (err) {
        Logger.log('ERROR: Błąd parsowania koszyka - ' + err.message);
        return jsonResponse({ success: false, message: 'Błąd parsowania koszyka' });
      }

      return jsonResponse(wyslijZamowienie_v3(userName, userEmail, cart, sklep, promo));
    }

    return jsonResponse({ error: 'Unknown action' });
  } catch (error) {
    Logger.log('ERROR w doGet: ' + error.toString());
    return jsonResponse({ error: error.toString() });
  }
}

function jsonResponse(data) {
  return ContentService
    .createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}

// === HANDLOWCY (A = Imię i Nazwisko, B = Email) ===
function getHandlowcy() {
  try {
    const ss = SpreadsheetApp.openById(SS_ID);
    const sh = ss.getSheetByName('Handlowcy');
    if (!sh) return [];

    const values = sh.getDataRange().getValues();
    if (!values || values.length < 2) return [];

    const out = [];
    for (let i = 1; i < values.length; i++) {
      const name  = values[i][0];
      const email = values[i][1];
      if (name && email) {
        out.push({ nazwa: String(name).trim(), email: String(email).trim() });
      }
    }
    return out;
  } catch (e) {
    throw new Error('getHandlowcy(): ' + e.message);
  }
}

// === PRODUKTY (2 ARKUSZE: Produkty + Produkty_INFO) ===
function getProdukty() {
  try {
    const ss = SpreadsheetApp.openById(SS_ID);

    // 1) Arkusz "Produkty" - Symbol | EAN | Nazwa | NEW | PROMO | GAZETKA | KOLOR
    const arkuszProdukty = ss.getSheetByName('Produkty');
    if (!arkuszProdukty) {
      return [];
    }

    const dataProdukty = arkuszProdukty.getDataRange().getValues();
    if (dataProdukty.length < 2) {
      return [];
    }

    const headersProd = dataProdukty[0].map(h => String(h).trim().toLowerCase());
    const colProd = (name) => headersProd.indexOf(String(name).toLowerCase());

    // DEBUGOWANIE: loguj nagłówki
    Logger.log('=== NAGŁÓWKI ARKUSZA PRODUKTY ===');
    Logger.log('Wszystkie kolumny: ' + JSON.stringify(headersProd));

    const idxSymbol = colProd('symbol');
    const idxEAN = colProd('ean');
    const idxNazwa = colProd('nazwa');
    const idxNEW = colProd('new');
    const idxPROMO = colProd('promo');
    const idxGAZETKA = colProd('gazetka'); // ✅ NOWA KOLUMNA v3.0.4
    const idxKolor = colProd('kolor');

    Logger.log('=== DIAGNOSTYKA KOLUMN ===');
    Logger.log('idxSymbol: ' + idxSymbol);
    Logger.log('idxEAN: ' + idxEAN);
    Logger.log('idxNazwa: ' + idxNazwa);
    Logger.log('idxNEW: ' + idxNEW);
    Logger.log('idxPROMO: ' + idxPROMO);
    Logger.log('idxGAZETKA: ' + idxGAZETKA); // ✅ LOG v3.0.4
    Logger.log('idxKolor: ' + idxKolor);

    if (idxSymbol === -1 || idxEAN === -1 || idxNazwa === -1) {
      return [];
    }

    // 2) Arkusz "Produkty_INFO" - wszystkie kolumny kalkulatora
    const arkuszInfo = ss.getSheetByName('Produkty_INFO');
    let infoMap = {};

    if (arkuszInfo) {
      const dataInfo = arkuszInfo.getDataRange().getValues();
      if (dataInfo.length >= 2) {
        const headersInfo = dataInfo[0].map(h => String(h).trim().toLowerCase());
        const colInfo = (name) => headersInfo.indexOf(String(name).toLowerCase());

        const idxSymbolInfo = colInfo('symbol');
        const idxQ1 = colInfo('q1');
        const idxQCO1 = colInfo('qco1');
        const idxQ2 = colInfo('q2');
        const idxQCO2 = colInfo('qco2');
        const idxQ3 = colInfo('q3');
        const idxQCO3 = colInfo('qco3');
        const idxImg = colInfo('img');
        const idxHashtag = colInfo('hashtag');
        const idxCechy = colInfo('cechy');
        const idxDane = colInfo('dane');
        const idxKompl = colInfo('kompl');
        const idxPowiazane = colInfo('powiazane');
        const idxCzesci = colInfo('czesci');

        if (idxSymbolInfo !== -1) {
          for (let i = 1; i < dataInfo.length; i++) {
            const row = dataInfo[i];
            const rawSymbol = row[idxSymbolInfo];
            if (!rawSymbol) continue;

            const sym = String(rawSymbol).trim().toUpperCase().replace(/\s+/g, '');

            // Pomocnicza funkcja do pobierania wartości
            const getVal = (idx, defaultVal = '') => {
              if (idx === -1) return defaultVal;
              const val = row[idx];
              return (val === null || val === undefined || val === '') ? defaultVal : val;
            };

            const q1Val = getVal(idxQ1, null);
            const q2Val = getVal(idxQ2, null);
            const q3Val = getVal(idxQ3, null);

            infoMap[sym] = {
              Q1: (q1Val !== null) ? Number(q1Val) : 1,
              QCO1: String(getVal(idxQCO1, 'szt.')).trim(),
              Q2: (q2Val !== null) ? Number(q2Val) : 0,
              QCO2: String(getVal(idxQCO2, '')).trim(),
              Q3: (q3Val !== null) ? Number(q3Val) : 0,
              QCO3: String(getVal(idxQCO3, '')).trim(),
              IMG: String(getVal(idxImg, '')).trim(),
              Hashtag: String(getVal(idxHashtag, '')).trim(),
              Cechy: String(getVal(idxCechy, '')).trim(),
              Dane: String(getVal(idxDane, '')).trim(),
              Kompl: String(getVal(idxKompl, '')).trim(),
              Powiazane: String(getVal(idxPowiazane, '')).trim(),
              Czesci: String(getVal(idxCzesci, '')).trim()
            };
          }
        }
      }
    }

    // 3) Łączenie danych z obu arkuszy
    const produkty = [];
    for (let i = 1; i < dataProdukty.length; i++) {
      const row = dataProdukty[i];
      const rawSymbol = row[idxSymbol];
      if (!rawSymbol || String(rawSymbol).trim() === '') continue;

      const symbolNorm = String(rawSymbol).trim().toUpperCase().replace(/\s+/g, '');

      const produkt = {
        symbol: symbolNorm,
        ean: String(row[idxEAN] || '').replace(/\s+/g, '').trim(),
        nazwa: String(row[idxNazwa] || '').trim(),
        NEW: (idxNEW !== -1 && String(row[idxNEW] || '').trim().toUpperCase() === 'NEW') ? 'NEW' : '',
        PROMO: (idxPROMO !== -1 && String(row[idxPROMO] || '').trim().toUpperCase() === 'PROMO') ? 'PROMO' : '',
        GAZETKA: (idxGAZETKA !== -1 && String(row[idxGAZETKA] || '').trim().toUpperCase() === 'GAZETKA') ? 'GAZETKA' : '', // ✅ NOWA KOLUMNA v3.0.4
        kolor: (idxKolor !== -1) ? String(row[idxKolor] || '').trim() : ''
      };

      // DEBUGOWANIE: loguj pierwsze produkty z oznaczeniami
      if (produkt.NEW === 'NEW' || produkt.PROMO === 'PROMO' || produkt.GAZETKA === 'GAZETKA') {
        Logger.log('Produkt: ' + produkt.symbol + ' | NEW=' + produkt.NEW + ' | PROMO=' + produkt.PROMO + ' | GAZETKA=' + produkt.GAZETKA);
      }

      // Dodajemy dane z Produkty_INFO (jeśli istnieją)
      const info = infoMap[symbolNorm];
      if (info) {
        produkt.q1 = info.Q1;
        produkt.qco1 = info.QCO1;
        produkt.q2 = info.Q2;
        produkt.qco2 = info.QCO2;
        produkt.q3 = info.Q3;
        produkt.qco3 = info.QCO3;
        produkt.IMG = info.IMG;
        produkt.hashtag = info.Hashtag;
        produkt.Cechy = info.Cechy;
        produkt.Dane = info.Dane;
        produkt.Kompl = info.Kompl;
        produkt.Powiazane = info.Powiazane;
        produkt.Czesci = info.Czesci;
      } else {
        // Wartości domyślne jeśli brak danych w Produkty_INFO
        produkt.q1 = 1;
        produkt.qco1 = 'szt.';
        produkt.q2 = 0;
        produkt.qco2 = '';
        produkt.q3 = 0;
        produkt.qco3 = '';
        produkt.IMG = '';
        produkt.hashtag = '';
        produkt.Cechy = '';
        produkt.Dane = '';
        produkt.Kompl = '';
        produkt.Powiazane = '';
        produkt.Czesci = '';
      }

      produkty.push(produkt);
    }

    return produkty;
  } catch (error) {
    throw new Error('getProdukty(): ' + error.message);
  }
}

// === POS (kolumny: POKAZ | SYMBOL | NAZWA | OPIS | ZDJECIE) ===
function getPOS() {
  try {
    const ss = SpreadsheetApp.openById(SS_ID);
    const sh = ss.getSheetByName('POS');
    if (!sh) return [];

    const data = sh.getDataRange().getValues();
    if (!data || data.length < 2) return [];

    const head = data[0].map(h => String(h).trim().toLowerCase());
    const col = (name) => head.indexOf(String(name).toLowerCase());

    const pick = (row, name) => {
      const i = col(name);
      return i >= 0 ? row[i] : '';
    };

    const out = [];
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const pokazRaw = String(pick(row, 'pokaz') || '').toLowerCase();
      const pokaz = /(tak|true|1|x|yes)/.test(pokazRaw);

      if (!pokaz) continue;

      const symbol = String(pick(row, 'symbol') || '');
      const nazwa  = String(pick(row, 'nazwa') || '');
      const opis   = String(pick(row, 'opis') || '');
      const zdj    = String(pick(row, 'zdjecie') || '');

      if (!symbol && !nazwa) continue;

      out.push({
        symbol: symbol,
        nazwa: nazwa,
        opis: opis,
        zdjecie: zdj
      });
    }
    return out;
  } catch (e) {
    throw new Error('getPOS(): ' + e.message);
  }
}

// === ZESTAWY (SYMBOL | NAZWA | GRATIS | KOMENTARZ | SYMBOL* | ILOSC*) ===
function getZestawy() {
  try {
    const ss = SpreadsheetApp.openById(SS_ID);
    const sh = ss.getSheetByName('Zestawy');
    if (!sh) return [];

    const data = sh.getDataRange().getValues();
    if (!data || data.length < 2) return [];

    const headers = data[0].map(h => String(h).trim().toUpperCase());

    const idxSymbol = headers.indexOf('SYMBOL');
    const idxNazwa = headers.indexOf('NAZWA');
    const idxGratis = headers.indexOf('GRATIS');
    const idxKomentarz = headers.indexOf('KOMENTARZ');
    const idxKolor = headers.indexOf('KOLOR');
    const idxNEW = headers.indexOf('NEW'); // ✅ NOWA KOLUMNA v3.0.4
    const idxPROMO = headers.indexOf('PROMO'); // ✅ NOWA KOLUMNA v3.0.4
    const idxGAZETKA = headers.indexOf('GAZETKA'); // ✅ NOWA KOLUMNA v3.0.4

    // Znajdź WSZYSTKIE kolumny SYMBOL* (SYMBOL1, SYMBOL2, SYMBOL23, itd.)
    const symbolColumns = [];
    headers.forEach((header, index) => {
      // Sprawdź czy kolumna zaczyna się od "SYMBOL" i ma numer
      const match = header.match(/^SYMBOL(\d+)$/);
      if (match) {
        const num = parseInt(match[1]);
        symbolColumns.push({ num: num, symbolIdx: index });
      }
    });

    // Sortuj według numeru
    symbolColumns.sort((a, b) => a.num - b.num);

    const out = [];
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const symbol = String(row[idxSymbol] || '').trim();
      if (!symbol) continue;

      const zestaw = {
        symbol: symbol,
        nazwa: (idxNazwa !== -1) ? String(row[idxNazwa] || '').trim() : '',
        gratis: (idxGratis !== -1) ? String(row[idxGratis] || '').trim() : '',
        komentarz: (idxKomentarz !== -1) ? String(row[idxKomentarz] || '').trim() : '',
        kolor: (idxKolor !== -1) ? String(row[idxKolor] || '').trim() : '',
        NEW: (idxNEW !== -1 && String(row[idxNEW] || '').trim().toUpperCase() === 'NEW') ? 'NEW' : '', // ✅ NOWA KOLUMNA v3.0.4
        PROMO: (idxPROMO !== -1 && String(row[idxPROMO] || '').trim().toUpperCase() === 'PROMO') ? 'PROMO' : '', // ✅ NOWA KOLUMNA v3.0.4
        GAZETKA: (idxGAZETKA !== -1 && String(row[idxGAZETKA] || '').trim().toUpperCase() === 'GAZETKA') ? 'GAZETKA' : '', // ✅ NOWA KOLUMNA v3.0.4
        pozycje: []
      };

      // Dla każdej znalezionej kolumny SYMBOL*, szukaj odpowiadającej ILOSC*
      symbolColumns.forEach(col => {
        const idxSym = col.symbolIdx;
        const idxIlosc = headers.indexOf('ILOSC' + col.num);

        if (idxIlosc !== -1) {
          const sym = String(row[idxSym] || '').trim();
          const qty = Number(row[idxIlosc]) || 0;
          if (sym) {
            zestaw.pozycje.push({ symbol: sym, ilosc: qty });
          }
        }
      });

      out.push(zestaw);
    }
    return out;
  } catch (e) {
    throw new Error('getZestawy(): ' + e.message);
  }
}

// === WYSYŁKA ZAMÓWIENIA v3 z DEBUGOWANIEM ===
function wyslijZamowienie_v3(userName, userEmail, cart, sklep, promoComment) {
  try {
    Logger.log('=== ROZPOCZĘTO wyslijZamowienie_v3 ===');
    Logger.log('userName: "' + userName + '"');
    Logger.log('userEmail: "' + userEmail + '"');
    Logger.log('sklep: "' + sklep + '"');
    Logger.log('promoComment: "' + promoComment + '"');
    Logger.log('cart length: ' + cart.length);

    if (!cart || !cart.length) {
      Logger.log('ERROR: Koszyk pusty');
      return { success: false, message: 'Koszyk pusty' };
    }

    if (!sklep || String(sklep).trim() === '') {
      Logger.log('ERROR: Brak nazwy sklepu');
      return { success: false, message: 'Podaj sklep / odbiorcę przed wysłaniem' };
    }

    const ss = SpreadsheetApp.openById(SS_ID);
    let sh = ss.getSheetByName('Zamowienia');

    if (!sh) {
      Logger.log('INFO: Tworzę nowy arkusz Zamowienia');
      sh = ss.insertSheet('Zamowienia');
      sh.appendRow(['Data','Handlowiec','Sklep','Symbol','Ilość']);
    }

    const ts = new Date();
    const tsStr = Utilities.formatDate(ts, TZ, 'yyyy-MM-dd HH:mm:ss');

    const rows = cart.map(it => [
      ts,
      userName,
      String(sklep).trim(),
      it.symbol,
      it.ilosc
    ]);

    if (rows.length > 0) {
      Logger.log('INFO: Zapisuję ' + rows.length + ' wierszy do arkusza');
      sh.getRange(sh.getLastRow() + 1, 1, rows.length, rows[0].length).setValues(rows);
    }

    // CSV załącznik
    const csvRows = [['symbol','ilosc'], ...cart.map(it => [it.symbol, it.ilosc])];
    const csv = csvRows.map(r => r.join(';')).join('\n');
    const blob = Utilities.newBlob(csv, 'text/csv', 'zamowienie.csv');

    Logger.log('INFO: Utworzono plik CSV, rozmiar: ' + blob.getBytes().length + ' bajtów');

    // Tabela HTML
    const tableRows = cart.map(it =>
      `<tr><td style="padding:6px 10px;border:1px solid #ddd;">${escapeHtml(it.symbol)}</td>` +
      `<td style="padding:6px 10px;border:1px solid #ddd;text-align:right;">${Number(it.ilosc)}</td></tr>`
    ).join('');

    const htmlTable = `
      <table style="border-collapse:collapse;font-family:Arial,Helvetica,sans-serif;font-size:14px;">
        <thead>
          <tr>
            <th style="padding:8px 10px;border:1px solid #ddd;background:#f3f4f6;text-align:left;">Symbol</th>
            <th style="padding:8px 10px;border:1px solid #ddd;background:#f3f4f6;text-align:right;">Ilość</th>
          </tr>
        </thead>
        <tbody>${tableRows}</tbody>
      </table>`;

    const promoSafe = String(promoComment || '').trim();
    const sklepSafe = String(sklep || '').trim();

    const html = `
      <div style="font-family:Arial,Helvetica,sans-serif;font-size:14px;color:#111;">
        <p><b>Handlowiec:</b> ${escapeHtml(userName)}<br>
        <b>Sklep:</b> ${escapeHtml(sklepSafe)}<br>
        <b>Data:</b> ${tsStr}</p>
        ${promoSafe ? `<p><b>Informacje/Promocja:</b><br>${escapeMultiline(promoSafe)}</p>` : ''}
        ${htmlTable}
        <p style="color:#6b7280;margin-top:12px;">Załączono również plik CSV do importu.</p>
      </div>`;

    Logger.log('INFO: Wysyłam email do: ' + userEmail);
    Logger.log('INFO: Temat: Zamówienie: ' + sklepSafe + ' – ' + userName);

    try {
      MailApp.sendEmail({
        to: userEmail,
        subject: `Zamówienie: ${sklepSafe} – ${userName}`,
        htmlBody: html,
        attachments: [blob]
      });
      Logger.log('SUCCESS: Email wysłany pomyślnie!');
    } catch (mailError) {
      Logger.log('ERROR wysyłania maila: ' + mailError.toString());
      throw mailError;
    }

    return { success: true, message: 'Zamówienie wysłane' };
  } catch (e) {
    Logger.log('ERROR w wyslijZamowienie_v3: ' + e.toString());
    Logger.log('Stack trace: ' + e.stack);
    return { success: false, message: 'wyslijZamowienie_v3(): ' + e.message };
  }
}

// Wsteczna zgodność
function wyslijZamowienie_v2(userName, userEmail, cart, sklep) {
  return wyslijZamowienie_v3(userName, userEmail, cart, sklep, '');
}

function wyslijZamowienie(userName, userEmail, cart) {
  return wyslijZamowienie_v3(userName, userEmail, cart, '', '');
}

// === UTIL ===
function escapeHtml(s) {
  return String(s)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#039;');
}

function escapeMultiline(s) {
  return escapeHtml(s).replace(/\n/g,'<br>');
}

// === FUNKCJA TESTOWA - możesz ją uruchomić ręcznie ===
function testWyslijZamowienie() {
  Logger.log('=== TEST WYSYŁKI ===');
  
  // ZMIEŃ TEN EMAIL NA SWÓJ!
  const testEmail = 'sebastian.glusinski@gmail.com';
  
  const testCart = [
    { symbol: 'TEST123', ilosc: 5, nazwa: 'Produkt testowy 1' },
    { symbol: 'TEST456', ilosc: 3, nazwa: 'Produkt testowy 2' }
  ];
  
  const result = wyslijZamowienie_v3(
    'Test User',
    testEmail,
    testCart,
    'Test Sklep',
    'To jest testowe zamówienie'
  );
  
  Logger.log('Wynik: ' + JSON.stringify(result));
  
  if (result.success) {
    Logger.log('✅ TEST PASSED - sprawdź swoją skrzynkę mailową!');
  } else {
    Logger.log('❌ TEST FAILED - ' + result.message);
  }
}
