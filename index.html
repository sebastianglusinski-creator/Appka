<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>PDA DEDRA v5.2.0 üî• [09-11-2025 15:45]</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no"/>
  
  <!-- ANTY-CACHE -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="DEDRA v5.2.0">
  <meta name="theme-color" content="#2563eb">
  
  <!-- Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- Ikony -->
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet" />
  <style>
    *{box-sizing:border-box}
    :root{
      --blue:#2563eb;--blue-dark:#1e40af;--ink:#111827;--muted:#6b7280;--bg:#f5f7fb;
      --success:#10b981;--danger:#ef4444;--ring:rgba(37,99,235,.15);
      --nav-h:82px;
      --q1:#e0f2fe;--q2:#dcfce7;--q3:#fee2e2;
      --orange:#f97316;
    }
    html,body{height:100%;overflow-x:hidden}
    body{
      margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif;
      background:var(--bg);color:var(--ink);-webkit-text-size-adjust:100%;
      -webkit-user-select:none;user-select:none;touch-action:manipulation;
    }
    input,select,textarea{font-size:18px!important}
    
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

    #loginScreen{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--blue),var(--blue-dark));padding:24px;color:#fff}
    .card{width:100%;max-width:600px;background:#fff;color:#111;border-radius:22px;padding:28px 26px;box-shadow:0 12px 36px rgba(0,0,0,.18)}
    .title{font-size:30px;font-weight:900;margin-bottom:8px}
    .subtitle{opacity:.8;margin-bottom:16px;color:#374151}
    select{width:100%;padding:18px 16px;border:2px solid #e5e7eb;border-radius:14px;outline:none;background:#fff;transition:.2s}
    select:focus{border-color:var(--blue);box-shadow:0 0 0 3px var(--ring)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:16px 18px;border:none;border-radius:14px;font-size:18px;font-weight:800;cursor:pointer;transition:.15s transform,.2s box-shadow}
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:var(--blue);color:#fff;box-shadow:0 8px 22px rgba(37,99,235,.35)}
    .login-footer{margin-top:14px;font-size:14px;opacity:.9;text-align:center;color:#e5e7eb}

    .topbar{position:sticky;top:0;z-index:100;background:linear-gradient(135deg,var(--blue),var(--blue-dark));color:#fff;box-shadow:0 2px 10px rgba(0,0,0,.15);display:flex;flex-direction:column}
    .topbar-header{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;padding:8px 10px;gap:8px;max-width:100%;position:relative}
    .topbar-left{justify-content:flex-start}
    .topbar-right{justify-content:flex-end}
    .brand{height:26px;max-width:190px;object-fit:contain;pointer-events:none}
    .topbar-actions{display:flex;gap:8px;align-items:center}
    .icon-top{font-family:'Material Symbols Rounded';font-size:22px;color:#fff;width:44px;height:44px;display:flex;align-items:center;justify-content:center;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,.25);cursor:pointer;transition:background .2s,transform .1s;font-weight:900}
    .icon-top:hover{background:rgba(255,255,255,.12)}
    .icon-top:active{transform:scale(.97)}
    #userAvatar{font-size:14px}
    .icon-wrap{position:relative}
    .badge{position:absolute;top:-6px;right:-6px;background:var(--danger);color:#fff;font-size:11px;font-weight:800;min-width:18px;height:18px;border-radius:999px;display:flex;align-items:center;justify-content:center;padding:0 4px;box-shadow:0 0 0 2px var(--blue-dark)}
    .badge-blue{background:#0ea5e9}
    
    /* VERSION BADGE POD LOGO */
    .version-badge{position:absolute;bottom:-20px;left:50%;transform:translateX(-50%);background:#10b981;color:white;font-size:11px;font-weight:900;padding:4px 10px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.2);white-space:nowrap}

    .topbar-search{position:sticky;top:0;z-index:100;background:linear-gradient(135deg,var(--blue),var(--blue-dark));padding:8px 12px 12px}
    .search-wrap{display:flex;align-items:center;background:#fff;border-radius:12px;border:2px solid #d1d5db;height:48px;overflow:hidden}
    .search-wrap:focus-within{border-color:var(--blue);box-shadow:0 0 0 3px var(--ring)}
    #searchInput{flex:1;border:none;outline:none;background:transparent;font-size:16px;padding:0 14px;height:48px;line-height:48px;-webkit-appearance:none}
    #searchInput::-webkit-search-cancel-button{display:none;-webkit-appearance:none}
    #searchInput::-webkit-search-decoration{display:none;-webkit-appearance:none}
    
    .search-separator{width:1px;height:32px;background:#d1d5db;margin:0 4px;flex-shrink:0}
    
    .search-icons{display:flex;align-items:center;gap:10px;flex-shrink:0}
    .search-icon-btn{width:44px!important;height:44px!important;border:none!important;outline:none!important;border-radius:10px;background:transparent!important;color:#6b7280!important;display:flex;align-items:center;justify-content:center;cursor:pointer;font-family:'Material Symbols Rounded';font-size:24px!important;transition:background .2s,transform .1s,color .2s;flex-shrink:0;-webkit-tap-highlight-color:transparent}
    .search-icon-btn:active{transform:scale(.95)}
    .search-icon-btn:hover{background:rgba(0,0,0,0.05)!important;color:#374151!important}
    .search-icon-btn.mode-scanner{background:transparent!important;color:#059669!important}
    .search-icon-btn.clear-btn{background:transparent!important;color:#374151!important}
    .search-icon-btn.clear-btn:hover{background:rgba(0,0,0,0.05)!important;color:#111!important}

    #productList{padding:8px 12px calc(var(--nav-h) + 20px)}
    .product{display:flex;align-items:center;justify-content:space-between;gap:12px;background:#fff;border-radius:14px;padding:16px;margin:10px 0;box-shadow:0 2px 8px rgba(0,0,0,.06);transition:background .15s,box-shadow .15s;max-width:100%}
    .product:hover{box-shadow:0 4px 12px rgba(0,0,0,.12)}
    .product-left{display:flex;gap:12px;align-items:center;flex:1;min-width:0}
    .product-thumb{width:60px;height:60px;border-radius:10px;object-fit:cover;flex-shrink:0;background:#f3f4f6}
    .product-info{flex:1;min-width:0}
    .name{font-weight:900;font-size:18px;word-wrap:break-word}
    .codes{font-size:13px;color:var(--muted);margin-top:6px}
    
    /* BADGES v3.0.4 - NOWO≈öƒÜ, PROMOCJA, GAZETKA */
    .product-badges{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
    .product-badge{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:900;color:white;text-transform:uppercase;letter-spacing:0.5px;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    .badge-new{background:linear-gradient(135deg,#3b82f6,#60a5fa)}
    .badge-promo{background:linear-gradient(135deg,#ef4444,#f87171)}
    .badge-gazetka{background:linear-gradient(135deg,#16a34a,#22c55e)}

    .add-btn{width:50px;height:50px;border:none;border-radius:12px;background:var(--blue);color:#fff;font-size:28px;font-weight:700;cursor:pointer;transition:background .15s,transform .1s;flex-shrink:0;display:flex;align-items:center;justify-content:center}
    .add-btn:hover{background:var(--blue-dark)}
    .add-btn:active{transform:scale(.94)}
    
    /* BOTTOM NAV - KARUZELA v5.2.0 */
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;z-index:90;background:#fff;box-shadow:0 -2px 12px rgba(0,0,0,.1);transition:transform .25s ease;height:var(--nav-h);overflow:hidden}
    .bottom-nav.hide{transform:translateY(100%)}
    
    /* DESKTOP/TABLET - wszystkie ikony obok siebie */
    @media (min-width:769px){
      .carousel-container{display:flex!important;justify-content:center!important;align-items:center!important;gap:0!important;overflow:visible!important}
      .carousel-track{transform:none!important;justify-content:center!important;gap:0!important}
      .nav-item{opacity:1!important;pointer-events:auto!important}
      .nav-item .icon{font-size:26px!important}
      .nav-item.active .icon{font-size:32px!important}
      .center-circle{display:none!important}
      .bottom-nav{max-width:650px;left:50%;transform:translateX(-50%);border-radius:16px 16px 0 0}
      .bottom-nav.hide{transform:translateX(-50%) translateY(100%)}
    }
    
    /* MOBILE - karuzela */
    @media (max-width:768px){
      .carousel-container{position:relative;width:100%;height:100%;display:flex;align-items:center;justify-content:center;overflow:hidden}
      .carousel-track{display:flex;align-items:center;gap:0;transition:transform .35s cubic-bezier(0.4, 0.0, 0.2, 1);will-change:transform;position:relative}
      
      .nav-item{
        display:flex;
        flex-direction:column;
        align-items:center;
        justify-content:center;
        min-width:80px;
        padding:8px 4px;
        cursor:pointer;
        transition:all .35s cubic-bezier(0.4, 0.0, 0.2, 1);
        flex-shrink:0;
        opacity:0.4;
        pointer-events:none;
      }
      
      .nav-item .icon-wrap-nav{position:relative;display:inline-block}
      .nav-item .nav-badge{position:absolute;top:-8px;right:-8px;background:var(--danger);color:#fff;font-size:11px;font-weight:800;min-width:20px;height:20px;border-radius:999px;display:flex;align-items:center;justify-content:center;padding:0 5px;box-shadow:0 2px 4px rgba(0,0,0,.3);z-index:5}
      
      .nav-item .icon{
        font-family:'Material Symbols Rounded';
        font-size:24px;
        color:#9ca3af;
        margin-bottom:4px;
        transition:all .35s cubic-bezier(0.4, 0.0, 0.2, 1);
      }
      
      .nav-item .label{
        font-size:11px;
        font-weight:700;
        color:#9ca3af;
        transition:all .35s cubic-bezier(0.4, 0.0, 0.2, 1);
        white-space:nowrap;
      }
      
      /* Boczne ikony - widoczne ale nie aktywne */
      .nav-item.side-visible{
        opacity:1;
        pointer-events:auto;
      }
      
      /* ≈örodkowa ikona - AKTYWNA */
      .nav-item.center{
        opacity:1;
        pointer-events:auto;
        position:relative;
        z-index:10;
      }
      
      .nav-item.center .icon{
        font-size:32px;
        color:#2563eb;
      }
      
      .nav-item.center .label{
        color:#2563eb;
        font-weight:900;
      }
      
      /* NIEBIESKIE K√ì≈ÅKO NA ≈öRODKU */
      .center-circle{
        position:absolute;
        top:50%;
        left:50%;
        transform:translate(-50%,-50%);
        width:75px;
        height:75px;
        background:#2563eb;
        border-radius:50%;
        box-shadow:0 4px 16px rgba(37,99,235,.4);
        pointer-events:none;
        z-index:5;
      }
    }

    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:200;display:none;align-items:center;justify-content:center;padding:20px}
    .camera-box{width:100%;max-width:500px;background:#111827;border-radius:20px;padding:20px;position:relative}
    #cameraOverlay .modal-x{background:#374151}

    .modal-box{width:100%;max-width:720px;background:#fff;border-radius:16px;padding:18px;box-shadow:0 24px 60px rgba(0,0,0,.35);position:relative;max-height:85vh;display:flex;flex-direction:column;overflow:hidden}
    .modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
    .modal-title{font-size:22px;font-weight:900;color:var(--ink)}
    .modal-x{width:36px;height:36px;border-radius:8px;background:#f3f4f6;border:none;color:#6b7280;font-size:20px;cursor:pointer;transition:.2s;display:flex;align-items:center;justify-content:center;font-family:'Material Symbols Rounded'}
    .modal-x:hover{background:#e5e7eb;color:#374151}
    .modal-body{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch}
    .modal-footer{display:flex;gap:10px;margin-top:14px;padding-top:14px;border-top:1px solid #e5e7eb}

    .calc-wrap{background:#f9fafb;border-radius:12px;padding:14px;margin:12px 0}
    .calc-top{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .calc-label{font-size:15px;font-weight:700;color:var(--muted);white-space:nowrap}
    .calc-input{flex:1;padding:12px;border:2px solid #d1d5db;border-radius:10px;font-size:18px;font-weight:700;text-align:center;background:#fff;outline:none}
    .calc-input:focus{border-color:var(--blue);box-shadow:0 0 0 3px var(--ring)}
    .calc-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .calc-btn{padding:14px;border:none;border-radius:10px;background:#e5e7eb;color:#374151;font-size:18px;font-weight:800;cursor:pointer;transition:.15s}
    .calc-btn:active{transform:scale(.95)}
    .calc-btn.quick{background:var(--blue);color:#fff}
    
    .set-item{display:flex;align-items:flex-start;gap:10px;background:#f9fafb;border-radius:10px;padding:12px;margin:8px 0;border:2px solid transparent;transition:border .2s}
    .set-item.selected{border-color:var(--blue);background:#eff6ff}
    .set-check{width:44px;height:44px;border:2px solid #d1d5db;border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:.2s;font-family:'Material Symbols Rounded';font-size:24px;color:transparent}
    .set-item.selected .set-check{background:var(--blue);border-color:var(--blue);color:#fff}
    .set-info{flex:1;min-width:0}
    .set-name{font-weight:800;font-size:16px;margin-bottom:4px}
    .set-desc{font-size:13px;color:var(--muted);line-height:1.4}

    .empty{padding:40px 20px;text-align:center;color:var(--muted)}
    .empty-icon{font-family:'Material Symbols Rounded';font-size:64px;opacity:.3;margin-bottom:12px}
    
    .loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px;color:var(--muted)}
    .spinner{width:40px;height:40px;border:4px solid #e5e7eb;border-top-color:var(--blue);border-radius:50%;animation:spin 0.8s linear infinite;margin-bottom:12px}

    #toast{position:fixed;top:90px;left:50%;transform:translateX(-50%) translateY(-100px);background:#111827;color:#fff;padding:14px 20px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.25);opacity:0;transition:opacity .25s,transform .25s;z-index:999;max-width:calc(100% - 40px);text-align:center;font-weight:600;pointer-events:none}
    #toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

    .qty-badge{position:absolute;top:6px;right:6px;background:var(--blue);color:#fff;font-size:12px;font-weight:800;min-width:22px;height:22px;border-radius:999px;display:flex;align-items:center;justify-content:center;padding:0 6px;box-shadow:0 2px 6px rgba(0,0,0,.2)}
    
    #cartBtn.has-items{animation:pulse .4s ease}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}

    .cart-row{display:flex;align-items:center;gap:12px;padding:12px;background:#f9fafb;border-radius:10px;margin:8px 0}
    .cart-product{flex:1;min-width:0}
    .cart-name{font-weight:800;font-size:15px;margin-bottom:4px}
    .cart-code{font-size:12px;color:var(--muted)}
    .cart-qty-wrap{display:flex;align-items:center;gap:8px}
    .qty-btn{width:32px;height:32px;border:none;border-radius:8px;background:#e5e7eb;color:#374151;font-size:18px;font-weight:800;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.15s}
    .qty-btn:active{transform:scale(.9)}
    .cart-qty{font-size:16px;font-weight:800;min-width:30px;text-align:center}
    .cart-remove{width:32px;height:32px;border:none;border-radius:8px;background:#fee2e2;color:#dc2626;font-family:'Material Symbols Rounded';font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.15s}
    .cart-remove:active{transform:scale(.9)}

    #cartOverlay .modal-footer{flex-direction:column;gap:0}
    .promo-wrap{display:flex;flex-direction:column;gap:8px;margin-bottom:10px}
    .promo-label{font-size:13px;font-weight:700;color:var(--muted)}
    #cartPromo{width:100%;padding:10px;border:2px solid #d1d5db;border-radius:8px;font-size:14px;resize:vertical;outline:none;font-family:inherit;min-height:60px}
    #cartPromo:focus{border-color:var(--blue);box-shadow:0 0 0 3px var(--ring)}

    #sendCartBtn{width:100%;margin-top:10px}
  </style>
</head>
<body>

<div id="loginScreen">
  <div class="card">
    <div class="title">üõí PDA DEDRA</div>
    <div class="subtitle">Wybierz swoje imiƒô</div>
    <select id="userSelect">
      <option value="">-- Wybierz --</option>
      <option value="Damian">Damian</option>
      <option value="Kacper">Kacper</option>
      <option value="Kamil">Kamil</option>
      <option value="Mateusz">Mateusz</option>
      <option value="Dawid">Dawid</option>
    </select>
    <button class="btn btn-primary" style="width:100%;margin-top:16px" onclick="handleLogin()">
      <span class="material-symbols-rounded">login</span>
      Zaloguj siƒô
    </button>
    <div class="login-footer">Aplikacja PDA DEDRA v5.2.0 üî•</div>
  </div>
</div>

<div id="appScreen" style="display:none">
  <div class="topbar">
    <div class="topbar-header">
      <div class="topbar-actions topbar-left">
        <div class="icon-wrap">
          <div class="icon-top" id="cartBtn" onclick="openCart()">shopping_cart</div>
          <div class="badge" id="cartBadge" style="display:none">0</div>
        </div>
      </div>
      <div style="position:relative;display:inline-block">
        <img src="https://dedra.pl/themes/dedra2020/assets/img/logo.svg" alt="DEDRA" class="brand">
        <div class="version-badge">v5.2.0</div>
      </div>
      <div class="topbar-actions topbar-right">
        <div class="icon-top" id="userAvatar" onclick="handleLogout()">D</div>
      </div>
    </div>
  </div>

  <div class="topbar-search">
    <div class="search-wrap">
      <input type="search" id="searchInput" placeholder="Szukaj produktu..." autocomplete="off" />
      <div class="search-separator"></div>
      <div class="search-icons">
        <button class="search-icon-btn clear-btn" id="clearBtn" onclick="clearSearch()" style="display:none">close</button>
        <button class="search-icon-btn" id="toggleModeBtn" onclick="toggleScannerMode()">keyboard</button>
        <button class="search-icon-btn" onclick="openCamera()">photo_camera</button>
      </div>
    </div>
  </div>

  <section id="mainSection">
    <div id="productList"></div>
  </section>

  <div id="bottomNav" class="bottom-nav">
    <div class="carousel-container">
      <div class="center-circle"></div>
      <div class="carousel-track" id="carouselTrack">
        <div class="nav-item" data-tab="top" data-index="0">
          <span class="icon">trending_up</span>
          <span class="label">TOP</span>
        </div>
        <div class="nav-item" data-tab="zestawy" data-index="1">
          <span class="icon">redeem</span>
          <span class="label">Zestawy</span>
        </div>
        <div class="nav-item" data-tab="nowosci" data-index="2">
          <span class="icon">schedule</span>
          <span class="label">Nowo≈õci</span>
        </div>
        <div class="nav-item center active" data-tab="produkty" data-index="3">
          <span class="icon">inventory_2</span>
          <span class="label">Produkty</span>
        </div>
        <div class="nav-item" data-tab="zadania" data-index="4">
          <div class="icon-wrap-nav">
            <span class="icon">task_alt</span>
            <span class="nav-badge" id="zadaniaBadge" style="display:none">0</span>
          </div>
          <span class="label">Zadania</span>
        </div>
        <div class="nav-item" data-tab="promo" data-index="5">
          <span class="icon">sell</span>
          <span class="label">Promo</span>
        </div>
        <div class="nav-item" data-tab="pos" data-index="6">
          <span class="icon">folder_open</span>
          <span class="label">POS</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Bia≈Ça strona dla ZADANIA -->
  <div id="zadaniaScreen" style="display:none;position:fixed;inset:0;background:white;z-index:85">
    <div style="max-width:600px;margin:0 auto;padding:80px 20px;text-align:center">
      <div style="font-size:28px;font-weight:900;color:#111827;margin-bottom:12px">Zadania</div>
      <div style="font-size:16px;color:#6b7280;margin-bottom:24px">Ta funkcja zostanie wkr√≥tce dodana</div>
      <div style="font-size:64px;margin:30px 0">üìã</div>
      <button class="btn btn-primary" onclick="closeZadania()">
        <span class="material-symbols-rounded">arrow_back</span>
        Powr√≥t
      </button>
    </div>
  </div>
</div>

<div id="cameraOverlay" class="overlay">
  <div class="camera-box">
    <button class="modal-x" onclick="closeCamera()" style="position:absolute;top:12px;right:12px;z-index:10">close</button>
    <video id="cameraVideo" style="width:100%;border-radius:12px;background:#000"></video>
    <div id="cameraStatus" style="color:#10b981;text-align:center;margin-top:12px;font-weight:700">Skanowanie...</div>
  </div>
</div>

<div id="calcOverlay" class="overlay">
  <div class="modal-box">
    <div class="modal-head">
      <div class="modal-title" id="calcTitle">Kalkulator</div>
      <button class="modal-x" onclick="closeCalc()">close</button>
    </div>
    <div class="modal-body">
      <div id="calcProductInfo" style="padding:12px;background:#f3f4f6;border-radius:10px;margin-bottom:14px">
        <div style="font-weight:800;font-size:16px;margin-bottom:4px" id="calcProductName"></div>
        <div style="font-size:13px;color:#6b7280" id="calcProductCode"></div>
      </div>
      <div class="calc-wrap">
        <div class="calc-top">
          <div class="calc-label">Ilo≈õƒá:</div>
          <input type="number" id="calcQty" class="calc-input" value="1" min="1" readonly />
        </div>
        <div class="calc-grid">
          <button class="calc-btn" onclick="calcAppend('7')">7</button>
          <button class="calc-btn" onclick="calcAppend('8')">8</button>
          <button class="calc-btn" onclick="calcAppend('9')">9</button>
          <button class="calc-btn" onclick="calcAppend('4')">4</button>
          <button class="calc-btn" onclick="calcAppend('5')">5</button>
          <button class="calc-btn" onclick="calcAppend('6')">6</button>
          <button class="calc-btn" onclick="calcAppend('1')">1</button>
          <button class="calc-btn" onclick="calcAppend('2')">2</button>
          <button class="calc-btn" onclick="calcAppend('3')">3</button>
          <button class="calc-btn" onclick="calcClear()">C</button>
          <button class="calc-btn" onclick="calcAppend('0')">0</button>
          <button class="calc-btn" onclick="calcBackspace()">‚å´</button>
        </div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px">
          <button class="calc-btn quick" onclick="calcSet(5)">+5</button>
          <button class="calc-btn quick" onclick="calcSet(10)">+10</button>
          <button class="calc-btn quick" onclick="calcSet(20)">+20</button>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" style="flex:1;background:#e5e7eb;color:#374151" onclick="closeCalc()">Anuluj</button>
      <button class="btn btn-primary" style="flex:1" onclick="confirmCalc()">Dodaj</button>
    </div>
  </div>
</div>

<div id="setOverlay" class="overlay">
  <div class="modal-box">
    <div class="modal-head">
      <div class="modal-title">Zestawy</div>
      <button class="modal-x" onclick="closeSet()">close</button>
    </div>
    <div class="modal-body" id="setList"></div>
    <div class="modal-footer">
      <button class="btn" style="flex:1;background:#e5e7eb;color:#374151" onclick="closeSet()">Anuluj</button>
      <button class="btn btn-primary" style="flex:1" onclick="confirmSet()">Dodaj zestaw</button>
    </div>
  </div>
</div>

<div id="cartOverlay" class="overlay">
  <div class="modal-box">
    <div class="modal-head">
      <div class="modal-title">üõí Koszyk</div>
      <button class="modal-x" onclick="closeCart()">close</button>
    </div>
    <div class="modal-body" id="cartList"></div>
    <div class="modal-footer">
      <div class="promo-wrap">
        <label class="promo-label">Komentarz / Promocja:</label>
        <textarea id="cartPromo" placeholder="Wpisz komentarz lub kod promocji..."></textarea>
      </div>
      <button class="btn btn-primary" id="sendCartBtn" onclick="sendCart()">
        <span class="material-symbols-rounded">send</span>
        Wy≈õlij zam√≥wienie
      </button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
<script>
console.log('%cüî• PDA DEDRA v5.2.0 üî•','color:#2563eb;font-size:24px;font-weight:900');
console.log('%cZa≈Çadowano: 09.11.2025, 15:45:30','color:#10b981;font-size:14px;font-weight:700');
console.log('%cTimestamp: 09-11-2025 15:45','color:#6b7280;font-size:12px');

const API_URL = 'https://script.google.com/macros/s/AKfycbzLIrnwgFgJ2Q_gIHpO5O3YE0uu7gAxrRGAW0rnkBD-pB_c5vcIMJCEW-KHs0G2g6Zz/exec';

const $ = id => document.getElementById(id);
let currentUser = '';
let allProducts = [];
let allSets = [];
let posItems = [];
let cart = [];
let currentTab = 'produkty';
let scannerMode = false;
let tempProductForCalc = null;
let selectedSets = [];

// KARUZELA v5.2.0
let carouselIndex = 3; // Start na "Produkty" (index 3)
const navItems = Array.from(document.querySelectorAll('.nav-item'));
const totalItems = navItems.length;

async function callAPI(action, params = {}) {
  try {
    const url = new URL(API_URL);
    url.searchParams.append('action', action);
    Object.keys(params).forEach(k => url.searchParams.append(k, params[k]));
    const res = await fetch(url);
    if (!res.ok) throw new Error('Network error');
    return await res.json();
  } catch (err) {
    console.error('API Error:', err);
    toast('‚ùå B≈ÇƒÖd po≈ÇƒÖczenia');
    return null;
  }
}

function handleLogin() {
  const sel = $('userSelect');
  if (!sel.value) return toast('Wybierz u≈ºytkownika');
  currentUser = sel.value;
  $('userAvatar').textContent = currentUser[0].toUpperCase();
  $('loginScreen').style.display = 'none';
  $('appScreen').style.display = 'block';
  initApp();
}

function handleLogout() {
  if (confirm('Czy na pewno chcesz siƒô wylogowaƒá?')) {
    currentUser = '';
    cart = [];
    $('loginScreen').style.display = 'flex';
    $('appScreen').style.display = 'none';
    $('userSelect').value = '';
  }
}

async function initApp() {
  showLoading();
  const [prod, sets, pos] = await Promise.all([
    callAPI('getProdukty'),
    callAPI('getZestawy'),
    callAPI('getPOS')
  ]);
  
  if (prod && prod.status === 'ok') allProducts = prod.data || [];
  if (sets && sets.status === 'ok') allSets = sets.data || [];
  if (pos && pos.status === 'ok') posItems = pos.data || [];
  
  renderCurrentTab();
  updateCarousel();
  updateZadaniaBadge();
}

function updateZadaniaBadge() {
  // Symulacja liczby zada≈Ñ (w przysz≈Ço≈õci pobieraƒá z API)
  const taskCount = 3;
  const badge = $('zadaniaBadge');
  if (taskCount > 0) {
    badge.textContent = taskCount;
    badge.style.display = 'flex';
  } else {
    badge.style.display = 'none';
  }
}

function showLoading() {
  $('productList').innerHTML = '<div class="loading"><div class="spinner"></div>≈Åadowanie...</div>';
}

function toast(msg) {
  const t = $('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

function clearSearch() {
  $('searchInput').value = '';
  $('clearBtn').style.display = 'none';
  renderCurrentTab();
}

$('searchInput').addEventListener('input', e => {
  $('clearBtn').style.display = e.target.value ? 'block' : 'none';
  renderCurrentTab();
});

function renderCurrentTab() {
  const query = $('searchInput').value.toLowerCase().trim();
  let filtered = allProducts;

  if (query) {
    filtered = allProducts.filter(p =>
      p.NAZWA?.toLowerCase().includes(query) ||
      p.KOD?.toLowerCase().includes(query) ||
      p.EAN?.toLowerCase().includes(query)
    );
  } else {
    if (currentTab === 'nowosci') {
      filtered = allProducts.filter(p => p.NEW === 'NEW');
    } else if (currentTab === 'promo') {
      filtered = allProducts.filter(p => p.PROMO === 'PROMO');
    } else if (currentTab === 'top') {
      filtered = allProducts.filter(p => p.TOP === 'TOP');
    }
  }

  if (currentTab === 'pos') {
    renderPOS(posItems);
    return;
  }
  if (currentTab === 'zestawy') {
    renderSets(allSets);
    return;
  }
  
  renderProducts(filtered);
}

function renderProducts(items) {
  if (!items || items.length === 0) {
    $('productList').innerHTML = '<div class="empty"><div class="empty-icon">search_off</div>Brak produkt√≥w</div>';
    return;
  }

  $('productList').innerHTML = items.map(p => {
    const badges = [];
    if (p.NEW === 'NEW') badges.push('<span class="product-badge badge-new">üåü NOWO≈öƒÜ</span>');
    if (p.PROMO === 'PROMO') badges.push('<span class="product-badge badge-promo">üî• PROMOCJA</span>');
    if (p.GAZETKA === 'GAZETKA') badges.push('<span class="product-badge badge-gazetka">üì∞ GAZETKA</span>');
    
    return `
      <div class="product">
        <div class="product-left">
          <div class="product-thumb"></div>
          <div class="product-info">
            <div class="name">${p.NAZWA || ''}</div>
            <div class="codes">
              ${p.KOD ? `<span>${p.KOD}</span>` : ''}
              ${p.KOD && p.EAN ? '<span>|</span>' : ''}
              ${p.EAN ? `<span>EAN: ${p.EAN}</span>` : ''}
            </div>
            ${badges.length > 0 ? `<div class="product-badges">${badges.join('')}</div>` : ''}
          </div>
        </div>
        <button class="add-btn" onclick='openCalc(${JSON.stringify(p)})'>+</button>
      </div>
    `;
  }).join('');
}

function renderPOS(items) {
  if (!items || items.length === 0) {
    $('productList').innerHTML = '<div class="empty"><div class="empty-icon">folder_off</div>Brak materia≈Ç√≥w POS</div>';
    return;
  }
  $('productList').innerHTML = items.map(p => `
    <div class="product">
      <div class="product-left">
        <div class="product-thumb"></div>
        <div class="product-info">
          <div class="name">${p.NAZWA || ''}</div>
          <div class="codes">${p.KOD || ''}</div>
        </div>
      </div>
      <button class="add-btn" onclick='openCalc(${JSON.stringify(p)})'>+</button>
    </div>
  `).join('');
}

function renderSets(items) {
  if (!items || items.length === 0) {
    $('productList').innerHTML = '<div class="empty"><div class="empty-icon">redeem</div>Brak zestaw√≥w</div>';
    return;
  }
  $('productList').innerHTML = items.map(s => `
    <div class="product" onclick="selectSet(${JSON.stringify(s)})">
      <div class="product-left">
        <div class="product-thumb" style="background:${s.COLOR || '#f3f4f6'}"></div>
        <div class="product-info">
          <div class="name">${s.NAZWA || ''}</div>
          <div class="codes">${s.OPIS || ''}</div>
        </div>
      </div>
      <button class="add-btn">‚Üí</button>
    </div>
  `).join('');
}

function selectSet(set) {
  openSetModal(set);
}

function openSetModal(set) {
  const items = (set.PRODUKTY || '').split(',').map(s => s.trim()).filter(Boolean);
  if (items.length === 0) {
    toast('Zestaw jest pusty');
    return;
  }

  const matched = items.map(kod => {
    const p = allProducts.find(x => x.KOD === kod);
    return p ? { ...p, selected: false } : null;
  }).filter(Boolean);

  if (matched.length === 0) {
    toast('Brak produkt√≥w w zestawie');
    return;
  }

  selectedSets = matched;
  $('setList').innerHTML = matched.map((p, i) => `
    <div class="set-item" id="setItem${i}" onclick="toggleSetItem(${i})">
      <div class="set-check" id="setCheck${i}">check</div>
      <div class="set-info">
        <div class="set-name">${p.NAZWA || ''}</div>
        <div class="set-desc">${p.KOD || ''} ${p.EAN ? '| EAN: ' + p.EAN : ''}</div>
      </div>
    </div>
  `).join('');
  
  $('setOverlay').style.display = 'flex';
}

function toggleSetItem(idx) {
  selectedSets[idx].selected = !selectedSets[idx].selected;
  const item = $('setItem' + idx);
  if (selectedSets[idx].selected) {
    item.classList.add('selected');
  } else {
    item.classList.remove('selected');
  }
}

function closeSet() {
  $('setOverlay').style.display = 'none';
  selectedSets = [];
}

function confirmSet() {
  const selected = selectedSets.filter(s => s.selected);
  if (selected.length === 0) {
    toast('Wybierz przynajmniej jeden produkt');
    return;
  }

  selected.forEach(p => {
    const existing = cart.find(c => c.KOD === p.KOD);
    if (existing) {
      existing.qty += 1;
    } else {
      cart.push({ ...p, qty: 1 });
    }
  });

  updateCartBadge();
  
  const promoEl = $('cartPromo');
  const lines = selected.map(p => `${p.KOD} x1`);
  const append = lines.join(' | ');
  if (append) {
    const cur = promoEl.value.trim();
    promoEl.value = cur ? (append + ' | ' + cur) : append;
  }
  closeSet();
  toast('Zestaw dodany (do koszyka i komentarza)');
}

function openCalc(product) {
  tempProductForCalc = product;
  $('calcProductName').textContent = product.NAZWA || '';
  $('calcProductCode').textContent = (product.KOD || '') + (product.EAN ? ' | EAN: ' + product.EAN : '');
  $('calcQty').value = '1';
  $('calcOverlay').style.display = 'flex';
}

function closeCalc() {
  $('calcOverlay').style.display = 'none';
  tempProductForCalc = null;
}

function calcAppend(n) {
  const inp = $('calcQty');
  const cur = inp.value;
  if (cur === '1') inp.value = n;
  else inp.value = cur + n;
}

function calcClear() {
  $('calcQty').value = '1';
}

function calcBackspace() {
  const inp = $('calcQty');
  let val = inp.value;
  if (val.length > 1) {
    inp.value = val.slice(0, -1);
  } else {
    inp.value = '1';
  }
}

function calcSet(num) {
  const inp = $('calcQty');
  const cur = parseInt(inp.value) || 0;
  inp.value = cur + num;
}

function confirmCalc() {
  const qty = parseInt($('calcQty').value) || 1;
  if (qty < 1) {
    toast('Ilo≈õƒá musi byƒá wiƒôksza ni≈º 0');
    return;
  }

  const existing = cart.find(c => c.KOD === tempProductForCalc.KOD);
  if (existing) {
    existing.qty += qty;
  } else {
    cart.push({ ...tempProductForCalc, qty });
  }

  updateCartBadge();
  closeCalc();
  toast(`Dodano ${qty}x ${tempProductForCalc.NAZWA}`);
}

function openCart() {
  if (cart.length === 0) {
    $('cartList').innerHTML = '<div class="empty"><div class="empty-icon">shopping_cart</div>Koszyk jest pusty</div>';
  } else {
    $('cartList').innerHTML = cart.map((item, i) => `
      <div class="cart-row">
        <div class="cart-product">
          <div class="cart-name">${item.NAZWA || ''}</div>
          <div class="cart-code">${item.KOD || ''}</div>
        </div>
        <div class="cart-qty-wrap">
          <button class="qty-btn" onclick="changeQty(${i}, -1)">-</button>
          <div class="cart-qty">${item.qty}</div>
          <button class="qty-btn" onclick="changeQty(${i}, 1)">+</button>
        </div>
        <button class="cart-remove" onclick="removeFromCart(${i})">close</button>
      </div>
    `).join('');
  }
  $('cartOverlay').style.display = 'flex';
}

function closeCart() {
  $('cartOverlay').style.display = 'none';
}

function changeQty(idx, delta) {
  cart[idx].qty += delta;
  if (cart[idx].qty < 1) cart[idx].qty = 1;
  updateCartBadge();
  openCart();
}

function removeFromCart(idx) {
  cart.splice(idx, 1);
  updateCartBadge();
  openCart();
}

function updateCartBadge() {
  const total = cart.reduce((sum, c) => sum + c.qty, 0);
  const badge = $('cartBadge');
  const btn = $('cartBtn');
  if (total > 0) {
    badge.textContent = total;
    badge.style.display = 'flex';
    btn.classList.add('has-items');
    setTimeout(() => btn.classList.remove('has-items'), 400);
  } else {
    badge.style.display = 'none';
  }
}

async function sendCart() {
  if (cart.length === 0) return toast('Koszyk jest pusty');
  
  const promo = $('cartPromo').value.trim();
  const items = cart.map(c => ({
    nazwa: c.NAZWA,
    kod: c.KOD,
    ean: c.EAN || '',
    qty: c.qty
  }));

  const payload = {
    user: currentUser,
    items: JSON.stringify(items),
    promo
  };

  $('sendCartBtn').disabled = true;
  $('sendCartBtn').innerHTML = '<div class="spinner" style="width:20px;height:20px;margin:0"></div>';

  const res = await callAPI('sendOrder', payload);

  $('sendCartBtn').disabled = false;
  $('sendCartBtn').innerHTML = '<span class="material-symbols-rounded">send</span> Wy≈õlij zam√≥wienie';

  if (res && res.status === 'ok') {
    toast('‚úÖ Zam√≥wienie wys≈Çane!');
    cart = [];
    updateCartBadge();
    $('cartPromo').value = '';
    closeCart();
  } else {
    toast('‚ùå B≈ÇƒÖd wysy≈Çki');
  }
}

function openCamera() {
  $('cameraOverlay').style.display = 'flex';
  const video = $('cameraVideo');
  
  Quagga.init({
    inputStream: {
      type: 'LiveStream',
      target: video,
      constraints: {
        width: { ideal: 1280 },
        height: { ideal: 720 },
        facingMode: 'environment'
      }
    },
    decoder: { readers: ['ean_reader'] }
  }, err => {
    if (err) {
      console.error(err);
      toast('‚ùå B≈ÇƒÖd kamery');
      closeCamera();
      return;
    }
    Quagga.start();
  });

  Quagga.onDetected(data => {
    const code = data.codeResult.code;
    $('cameraStatus').textContent = `Zeskanowano: ${code}`;
    $('searchInput').value = code;
    renderCurrentTab();
    closeCamera();
    toast(`üì∑ Zeskanowano: ${code}`);
  });
}

function closeCamera() {
  Quagga.stop();
  $('cameraOverlay').style.display = 'none';
}

function toggleScannerMode() {
  const input = $('searchInput');
  const btn = $('toggleModeBtn');
  
  scannerMode = !scannerMode;
  
  if (scannerMode) {
    btn.textContent = 'barcode';
    btn.classList.add('mode-scanner');
    input.inputMode = 'none';
    input.readOnly = true;
  } else {
    btn.textContent = 'keyboard';
    btn.classList.remove('mode-scanner');
    input.inputMode = 'text';
    input.readOnly = false;
  }
}

document.addEventListener('touchstart', e => { 
  if (e.touches.length > 1) e.preventDefault(); 
}, { passive: false });

// ========== KARUZELA v5.2.0 ==========

function updateCarousel() {
  const isMobile = window.innerWidth <= 768;
  
  if (!isMobile) {
    // Desktop/Tablet - wszystkie ikony widoczne, bez karuzeli
    navItems.forEach(item => {
      item.classList.remove('center', 'side-visible');
      if (item.getAttribute('data-tab') === currentTab) {
        item.classList.add('active');
      } else {
        item.classList.remove('active');
      }
    });
    return;
  }
  
  // Mobile - karuzela
  const track = $('carouselTrack');
  const itemWidth = 80; // min-width z CSS
  const centerOffset = (window.innerWidth / 2) - (itemWidth / 2);
  const translateX = centerOffset - (carouselIndex * itemWidth);
  
  track.style.transform = `translateX(${translateX}px)`;
  
  // Update klas
  navItems.forEach((item, i) => {
    item.classList.remove('center', 'side-visible', 'active');
    
    const distance = Math.abs(i - carouselIndex);
    
    if (i === carouselIndex) {
      item.classList.add('center', 'active');
      currentTab = item.getAttribute('data-tab');
    } else if (distance === 1 || distance === 2) {
      item.classList.add('side-visible');
    }
  });
  
  renderCurrentTab();
}

function moveCarousel(direction) {
  carouselIndex = (carouselIndex + direction + totalItems) % totalItems;
  updateCarousel();
}

// Swipe support
let touchStartX = 0;
let touchEndX = 0;

$('carouselTrack').addEventListener('touchstart', e => {
  touchStartX = e.touches[0].clientX;
});

$('carouselTrack').addEventListener('touchend', e => {
  touchEndX = e.changedTouches[0].clientX;
  const diff = touchStartX - touchEndX;
  
  if (Math.abs(diff) > 50) {
    if (diff > 0) {
      moveCarousel(1); // Swipe left
    } else {
      moveCarousel(-1); // Swipe right
    }
  }
});

// Click on side item
navItems.forEach((item, index) => {
  item.addEventListener('click', () => {
    if (window.innerWidth <= 768) {
      // Mobile - przesu≈Ñ do ≈õrodka
      carouselIndex = index;
      updateCarousel();
    } else {
      // Desktop - bezpo≈õrednia aktywacja
      activateTab(item);
    }
  });
});

function activateTab(el) {
  document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
  el.classList.add('active');
  currentTab = el.getAttribute('data-tab') || 'produkty';
  
  if (currentTab === 'zadania') {
    $('mainSection').style.display = 'none';
    $('zadaniaScreen').style.display = 'block';
  } else {
    $('mainSection').style.display = 'block';
    $('zadaniaScreen').style.display = 'none';
    renderCurrentTab();
  }
}

function closeZadania() {
  $('zadaniaScreen').style.display = 'none';
  $('mainSection').style.display = 'block';
  
  // Prze≈ÇƒÖcz na Produkty
  carouselIndex = 3;
  updateCarousel();
}

// Scroll hide
(function initBottomNavAutoHide() {
  const nav = $('bottomNav'); 
  let lastY = window.scrollY, ticking = false;
  function onScroll() { 
    const y = window.scrollY; 
    const down = y > lastY; 
    if (down && y > 20) nav.classList.add('hide'); 
    else nav.classList.remove('hide'); 
    lastY = y; 
    ticking = false; 
  }
  window.addEventListener('scroll', () => { 
    if (!ticking) { 
      window.requestAnimationFrame(onScroll); 
      ticking = true; 
    } 
  }, { passive: true });
})();

// Resize handler
window.addEventListener('resize', () => {
  updateCarousel();
});

</script>
</body>
</html>
