<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>PDA DEDRA v1.7.0 PWA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="DEDRA">
  <meta name="theme-color" content="#2563eb">
  
  <!-- Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- Ikony -->
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet" />
  
  <!-- Biblioteka html5-qrcode do skanowania kamerą -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  
  <style>
    *{box-sizing:border-box}
    :root{
      --blue:#2563eb;--blue-dark:#1e40af;--ink:#111827;--muted:#6b7280;--bg:#f5f7fb;
      --success:#10b981;--danger:#ef4444;--ring:rgba(37,99,235,.15);
      --nav-h:82px;
      --q1:#e0f2fe;--q2:#dcfce7;--q3:#fee2e2;
      --orange:#f97316;
    }
    html,body{height:100%;overflow-x:hidden}
    body{
      margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif;
      background:var(--bg);color:var(--ink);-webkit-text-size-adjust:100%;
      -webkit-user-select:none;user-select:none;touch-action:manipulation;
    }
    input,select,textarea{font-size:18px!important}

    #loginScreen{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--blue),var(--blue-dark));padding:24px;color:#fff}
    .card{width:100%;max-width:600px;background:#fff;color:#111;border-radius:22px;padding:28px 26px;box-shadow:0 12px 36px rgba(0,0,0,.18)}
    .title{font-size:30px;font-weight:900;margin-bottom:8px}
    .subtitle{opacity:.8;margin-bottom:16px;color:#374151}
    select{width:100%;padding:18px 16px;border:2px solid #e5e7eb;border-radius:14px;outline:none;background:#fff;transition:.2s}
    select:focus{border-color:var(--blue);box-shadow:0 0 0 3px var(--ring)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:16px 18px;border:none;border-radius:14px;font-size:18px;font-weight:800;cursor:pointer;transition:.15s transform,.2s box-shadow}
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:var(--blue);color:#fff;box-shadow:0 8px 22px rgba(37,99,235,.35)}
    .login-footer{margin-top:14px;font-size:14px;opacity:.9;text-align:center;color:#e5e7eb}

    .topbar{position:sticky;top:0;z-index:100;background:linear-gradient(135deg,var(--blue),var(--blue-dark));color:#fff;box-shadow:0 2px 10px rgba(0,0,0,.15);display:flex;flex-direction:column}
    .topbar-header{display:grid;grid-template-columns:auto 1fr auto;align-items:center;padding:8px 10px;gap:8px;max-width:100%}
    .avatar{width:36px;height:36px;border-radius:999px;background:#1f2a60;display:flex;align-items:center;justify-content:center;font-weight:900}
    .avatar span{font-size:14px}
    .brand{height:26px;max-width:190px;object-fit:contain;justify-self:center}
    .topbar-actions{display:flex;gap:8px;justify-content:flex-end;align-items:center}
    .icon-top{font-family:'Material Symbols Rounded';font-size:22px;color:#fff;width:44px;height:44px;display:flex;align-items:center;justify-content:center;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,.25);cursor:pointer;transition:background .2s,transform .1s}
    .icon-top:hover{background:rgba(255,255,255,.12)}
    .icon-top:active{transform:scale(.97)}
    .icon-wrap{position:relative}
    .badge{position:absolute;top:-6px;right:-6px;background:var(--danger);color:#fff;font-size:11px;font-weight:800;min-width:18px;height:18px;border-radius:999px;display:flex;align-items:center;justify-content:center;padding:0 4px;box-shadow:0 0 0 2px var(--blue-dark)}
    .badge-blue{background:#0ea5e9}

    /* NOWY SEARCH BAR LAYOUT */
    .topbar-search{background:transparent;padding:8px 12px 12px;border-top:1px solid #dbeafe33;display:flex;align-items:center;gap:8px}
    .search-wrap{position:relative;flex:1;display:flex;align-items:center;background:#fff;border-radius:12px;padding-right:8px}
    #searchInput{flex:1;padding:16px 14px;border:none;border-radius:12px;outline:none;background:transparent;font-size:16px}
    
    /* SEPARATOR - pionowa kreska */
    .search-separator{width:1px;height:32px;background:#d1d5db;margin:0 4px}
    
    /* PRZYCISKI PO PRAWEJ: Toggle, Aparat, X */
    .search-icons{display:flex;align-items:center;gap:6px}
    .search-icon-btn{width:40px;height:40px;border:none;border-radius:10px;background:#f3f4f6;color:#374151;display:flex;align-items:center;justify-content:center;cursor:pointer;font-family:'Material Symbols Rounded';font-size:22px;transition:background .2s,transform .1s}
    .search-icon-btn:active{transform:scale(.95)}
    .search-icon-btn:hover{background:#e5e7eb}
    
    /* Toggle mode - zielony gdy aktywny */
    .search-icon-btn.mode-scanner{background:#dcfce7;color:#059669}
    
    /* Przycisk X - ciemniejszy */
    .search-icon-btn.clear-btn{background:#374151;color:#fff}
    .search-icon-btn.clear-btn:hover{background:#1f2937}

    /* OVERLAY APARATU */
    #cameraOverlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:500;display:none;align-items:center;justify-content:center;padding:20px}
    .camera-container{width:100%;max-width:500px;background:#fff;border-radius:20px;padding:20px;box-shadow:0 24px 60px rgba(0,0,0,.5);position:relative}
    .camera-title{font-size:20px;font-weight:900;margin-bottom:12px;text-align:center}
    #reader{width:100%;border-radius:12px;overflow:hidden;background:#000}
    .camera-cancel{margin-top:16px;width:100%;padding:14px;border:none;border-radius:12px;background:#374151;color:#fff;font-size:16px;font-weight:700;cursor:pointer}
    .camera-cancel:active{transform:scale(.98)}

    #productList{padding:8px 12px calc(var(--nav-h) + 20px)}
    .product{display:flex;align-items:center;justify-content:space-between;gap:12px;background:#fff;border-radius:14px;padding:16px;margin:10px 0;box-shadow:0 2px 8px rgba(0,0,0,.06);transition:background .15s,box-shadow .15s;max-width:100%}
    .product:hover{box-shadow:0 4px 12px rgba(0,0,0,.12)}
    .product-left{display:flex;gap:12px;align-items:center;flex:1;min-width:0}
    .product-thumb{width:60px;height:60px;border-radius:10px;object-fit:cover;flex-shrink:0;background:#f3f4f6}
    .product-info{flex:1;min-width:0}
    .name{font-weight:900;font-size:18px;word-wrap:break-word}
    .codes{font-size:13px;color:var(--muted);margin-top:6px}
    .actions{display:flex;align-items:center;gap:12px;margin-left:8px}
    .add-btn{min-width:60px;height:60px;border:none;border-radius:14px;cursor:pointer;font-size:26px;font-weight:900;color:#fff;display:flex;align-items:center;justify-content:center;background:var(--success);box-shadow:0 2px 6px rgba(0,0,0,.15);transition:transform .08s}
    .add-btn:active{transform:scale(.97)}
    .add-btn.orange{background:var(--orange)}

    .bottom-nav{position:fixed;left:0;right:0;bottom:0;height:var(--nav-h);background:#f9fafb;display:flex;justify-content:space-around;align-items:center;border-top:1px solid #e5e7eb;z-index:90;transition:transform .25s;padding:4px 0}
    .bottom-nav.hide{transform:translateY(100%)}
    .nav-item{display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:#6b7280;cursor:pointer;transition:all .2s;min-width:19%;padding:4px;-webkit-tap-highlight-color:transparent}
    .nav-item .icon{font-family:'Material Symbols Rounded';font-size:32px;line-height:1;width:52px;height:52px;display:flex;align-items:center;justify-content:center;border-radius:14px;background:transparent;margin-bottom:4px;color:#6b7280;transition:all .25s}
    .nav-item.active,.nav-item:hover{color:#2563eb}
    .nav-item.active .icon,.nav-item:hover .icon{background:#e0e7ff;color:#2563eb}

    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:200;display:none;align-items:center;justify-content:center;padding:20px}

    .modal-box{width:100%;max-width:720px;background:#fff;border-radius:16px;padding:18px;box-shadow:0 24px 60px rgba(0,0,0,.35);position:relative;max-height:85vh;overflow-y:auto}
    .modal-x{position:absolute;top:8px;right:8px;width:44px;height:44px;border:none;border-radius:12px;background:#111827;color:#fff;font-size:20px;font-weight:900;cursor:pointer;z-index:1}

    #syncOverlay{position:fixed;inset:0;background:rgba(17,24,39,.88);color:#fff;display:none;z-index:400;align-items:center;justify-content:center;padding:24px;text-align:center}
    #syncBox{max-width:520px;background:#111827;border:1px solid #334155;border-radius:14px;padding:18px;box-shadow:0 20px 50px rgba(0,0,0,.4)}
    #syncTitle{font-weight:900;font-size:18px;margin-bottom:8px}
    #syncText{opacity:.9;margin-bottom:4px}
    #syncStep{opacity:.7;font-size:14px}

    .toast-wrap{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(var(--nav-h) + 14px);z-index:460;display:none}
    .toast{background:#111827;color:#fff;padding:12px 16px;border-radius:12px;box-shadow:0 10px 26px rgba(0,0,0,.25);min-width:240px;text-align:center}

    .calc-box{width:100%;max-width:560px;background:#fff;border-radius:18px;padding:14px;box-shadow:0 24px 60px rgba(0,0,0,.35);position:relative;margin:auto;max-height:85vh}
    .calc-header{padding:6px 52px 10px 6px}
    .calc-title{font-weight:900;font-size:18px}
    .calc-sub{color:#6b7280;font-size:12px;margin-top:4px}
    .calc-close{position:absolute;top:8px;right:8px;width:44px;height:44px;border:none;border-radius:12px;background:#111827;color:#fff;font-size:20px;font-weight:900;cursor:pointer}
    
    .quick-grid{display:grid;gap:10px;margin:10px 0 12px}
    .quick-grid.one{grid-template-columns:1fr}
    .quick-grid.two{grid-template-columns:1fr 1fr}
    .quick-grid.three{grid-template-columns:1fr 1fr 1fr}
    .q-item{border:2px solid #e5e7eb;border-radius:14px;padding:14px 10px;text-align:center;font-weight:900;cursor:pointer;transition:transform .1s,box-shadow .15s;display:flex;flex-direction:column;align-items:center;gap:4px}
    .q-item:active{transform:scale(.96);box-shadow:0 2px 8px rgba(0,0,0,.15)}
    .q-item.q1{background:var(--q1);border-color:#bae6fd}
    .q-item.q2{background:var(--q2);border-color:#bbf7d0}
    .q-item.q3{background:var(--q3);border-color:#fecaca}
    .q-item .qv{font-size:28px;line-height:1}
    .q-item .ql{font-size:13px;opacity:.8;font-weight:600}
    
    .display{border:2px solid #e5e7eb;border-radius:14px;padding:16px;text-align:center;font-size:32px;font-weight:900;background:#fafafa;margin-bottom:12px}
    .display sub{font-size:14px;opacity:.6;font-weight:600}
    
    .pad{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .pad button{height:60px;border:none;border-radius:14px;background:#eef2f7;font-size:24px;font-weight:900;cursor:pointer;transition:transform .06s,box-shadow .12s}
    .pad button:active{transform:scale(.96);box-shadow:0 2px 6px rgba(0,0,0,.12)}
    .pad .danger{background:#fee2e2;color:#dc2626}
    .pad .back{background:#fef3c7;color:#ca8a04}
    
    .calc-add{margin-top:14px;width:100%;height:56px;border:none;border-radius:14px;background:#9ca3af;color:#fff;font-weight:900;font-size:17px;cursor:not-allowed;transition:all .2s}
    .calc-add.enabled{background:var(--blue);cursor:pointer;box-shadow:0 4px 12px rgba(37,99,235,.3)}
    .calc-add.enabled:active{transform:scale(.98)}

    .cart-title{font-size:20px;font-weight:900;margin-bottom:10px}
    .cart-table{width:100%;border-collapse:separate;border-spacing:0 8px;margin-top:8px}
    .cart-th{font-weight:900;color:#374151;font-size:13px;padding:0 6px}
    .cart-row{background:#fff;border:1px solid #e5e7eb;border-radius:12px}
    .cart-row td{padding:10px 8px;vertical-align:middle}
    .symname{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:13px}
    .qty-wrap{display:flex;align-items:center;gap:6px;justify-content:center}
    .qty-wrap button{width:32px;height:32px;border:none;border-radius:8px;background:#e5e7eb;font-size:18px;font-weight:900;cursor:pointer}
    .qty-wrap button:active{background:#d1d5db}
    .qty-wrap input{width:60px;text-align:center;border:1px solid #d1d5db;border-radius:8px;padding:6px 4px;font-weight:900;font-size:15px}
    .cart-del{width:36px;height:36px;border:none;border-radius:10px;background:#fee2e2;color:#dc2626;font-size:18px;font-weight:900;cursor:pointer}
    .cart-del:active{background:#fecaca}

    .order-section{margin-top:18px;border-top:1px solid #e5e7eb;padding-top:16px}
    .order-section label{display:block;font-weight:900;margin-bottom:6px;font-size:15px}
    .order-section input,.order-section select,.order-section textarea{width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:10px;font-size:15px;outline:none}
    .order-section input:focus,.order-section select:focus,.order-section textarea:focus{border-color:var(--blue);box-shadow:0 0 0 3px var(--ring)}
    .order-section textarea{resize:vertical;min-height:60px}

    .send-order{margin-top:18px;width:100%;height:58px;border:none;border-radius:14px;background:var(--blue);color:#fff;font-weight:900;font-size:18px;cursor:pointer;box-shadow:0 4px 12px rgba(37,99,235,.3)}
    .send-order:active{transform:scale(.98)}
    .send-order:disabled{background:#9ca3af;cursor:not-allowed}

    .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:12px}
    .stat-card{background:#fff;border-radius:14px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.06);text-align:center}
    .stat-value{font-size:32px;font-weight:900;color:var(--blue);margin-bottom:4px}
    .stat-label{font-size:13px;color:var(--muted);font-weight:700}

    .history-item{background:#fff;border-radius:14px;padding:16px;margin:10px 0;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .history-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .history-date{font-weight:900;font-size:16px}
    .history-status{padding:6px 12px;border-radius:8px;font-size:13px;font-weight:700}
    .history-status.pending{background:#fef3c7;color:#92400e}
    .history-status.sent{background:#dcfce7;color:#065f46}
    .history-details{font-size:14px;color:var(--muted);margin-top:8px}

    .empty-state{text-align:center;padding:60px 20px;color:var(--muted)}
    .empty-state .icon{font-size:64px;opacity:.3;margin-bottom:12px}
    .empty-state p{font-size:16px;font-weight:700}

    .alert-wrap{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:500;display:none;align-items:center;justify-content:center;padding:20px}
    .alert-box{background:#fff;border-radius:16px;padding:24px;max-width:400px;width:100%;box-shadow:0 24px 60px rgba(0,0,0,.4)}
    .alert-title{font-size:20px;font-weight:900;margin-bottom:12px}
    .alert-msg{font-size:15px;color:#374151;margin-bottom:20px}
    .alert-btn{width:100%;padding:14px;border:none;border-radius:12px;background:var(--blue);color:#fff;font-size:16px;font-weight:900;cursor:pointer}
    .alert-btn:active{transform:scale(.98)}

    .set-gratis{background:#dcfce7;border:2px solid #86efac;border-radius:12px;padding:12px;margin:10px 0;font-weight:700;color:#065f46;font-size:14px}

    /* Ukryty trigger do wymuszania klawiatury */
    #keyboardTrigger{position:absolute;left:-9999px;width:1px;height:1px;opacity:0}
  </style>
</head>
<body>

<!-- EKRAN LOGOWANIA -->
<div id="loginScreen">
  <div class="card">
    <div class="title">PDA DEDRA</div>
    <div class="subtitle">Zaloguj się aby kontynuować</div>
    <select id="userSelect">
      <option value="">Wybierz handlowca...</option>
    </select>
    <button class="btn btn-primary" style="width:100%;margin-top:18px" onclick="login()">
      <span class="material-symbols-rounded">login</span>
      Zaloguj
    </button>
    <div class="login-footer">Wersja 1.7.0 · PWA</div>
  </div>
</div>

<!-- GŁÓWNA APLIKACJA -->
<div id="app" style="display:none">
  <div class="topbar">
    <div class="topbar-header">
      <div class="avatar" onclick="logout()">
        <span id="userInitials">??</span>
      </div>
      <img src="https://dedra.pl/logo.png" alt="DEDRA" class="brand" onerror="this.style.display='none'">
      <div class="topbar-actions">
        <div class="icon-wrap">
          <div class="icon-top" onclick="showSync()">sync</div>
          <div class="badge" id="syncBadge" style="display:none">!</div>
        </div>
        <div class="icon-wrap">
          <div class="icon-top" onclick="activateTab(document.querySelector('[data-tab=koszyk]'))">shopping_cart</div>
          <div class="badge badge-blue" id="cartBadge" style="display:none">0</div>
        </div>
      </div>
    </div>
    
    <!-- NOWY SEARCHBAR Z IKONAMI -->
    <div class="topbar-search">
      <div class="search-wrap">
        <span class="material-symbols-rounded" style="color:#6b7280;margin-left:12px;font-size:20px">search</span>
        <input type="search" id="searchInput" placeholder="Szukaj..." autocomplete="off" inputmode="text">
        <div class="search-separator"></div>
        <div class="search-icons">
          <!-- TOGGLE: Klawiatura/Czytnik -->
          <button class="search-icon-btn" id="toggleModeBtn" onclick="toggleScannerMode()" title="Przełącz tryb">
            keyboard
          </button>
          <!-- APARAT -->
          <button class="search-icon-btn" onclick="openCamera()" title="Skanuj aparatem">
            photo_camera
          </button>
          <!-- WYCZYŚĆ -->
          <button class="search-icon-btn clear-btn" onclick="clearSearch()" title="Wyczyść">
            close
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="productList"></div>

  <div class="bottom-nav" id="bottomNav">
    <div class="nav-item active" data-tab="produkty" onclick="activateTab(this)">
      <div class="icon">inventory_2</div>
      <div>Produkty</div>
    </div>
    <div class="nav-item" data-tab="zestawy" onclick="activateTab(this)">
      <div class="icon">dashboard</div>
      <div>Zestawy</div>
    </div>
    <div class="nav-item" data-tab="koszyk" onclick="activateTab(this)">
      <div class="icon">shopping_cart</div>
      <div>Koszyk</div>
    </div>
    <div class="nav-item" data-tab="statystyki" onclick="activateTab(this)">
      <div class="icon">bar_chart</div>
      <div>Statystyki</div>
    </div>
    <div class="nav-item" data-tab="historia" onclick="activateTab(this)">
      <div class="icon">history</div>
      <div>Historia</div>
    </div>
  </div>
</div>

<!-- OVERLAY APARATU -->
<div id="cameraOverlay">
  <div class="camera-container">
    <div class="camera-title">Zeskanuj kod kreskowy</div>
    <div id="reader"></div>
    <button class="camera-cancel" onclick="closeCamera()">Anuluj</button>
  </div>
</div>

<!-- KALKULATOR -->
<div class="overlay" id="calcOverlay">
  <div class="calc-box">
    <button class="calc-close" onclick="closeCalc()">✕</button>
    <div class="calc-header">
      <div class="calc-title" id="calcProductName">Produkt</div>
      <div class="calc-sub" id="calcProductCode">EAN: ---</div>
    </div>
    
    <div class="quick-grid three" id="quickBtns"></div>
    
    <div class="display" id="calcDisplay">0<sub> szt</sub></div>
    
    <div class="pad">
      <button onclick="calcBtn('7')">7</button>
      <button onclick="calcBtn('8')">8</button>
      <button onclick="calcBtn('9')">9</button>
      <button onclick="calcBtn('4')">4</button>
      <button onclick="calcBtn('5')">5</button>
      <button onclick="calcBtn('6')">6</button>
      <button onclick="calcBtn('1')">1</button>
      <button onclick="calcBtn('2')">2</button>
      <button onclick="calcBtn('3')">3</button>
      <button class="back" onclick="calcBtn('back')">⌫</button>
      <button onclick="calcBtn('0')">0</button>
      <button class="danger" onclick="calcBtn('C')">C</button>
    </div>
    
    <button class="calc-add" id="calcAddBtn" onclick="confirmCalc()">Dodaj do koszyka</button>
  </div>
</div>

<!-- MODAL ZESTAWU -->
<div class="overlay" id="setOverlay">
  <div class="modal-box">
    <button class="modal-x" onclick="closeSet()">✕</button>
    <div class="cart-title" id="setTitle">Zestaw</div>
    <div class="set-gratis" id="setGratis" style="display:none"></div>
    <div id="setComment" style="font-size:14px;color:#6b7280;margin-bottom:10px"></div>
    <table class="cart-table">
      <thead>
        <tr>
          <th class="cart-th">Lp</th>
          <th class="cart-th">Produkt</th>
          <th class="cart-th">Ilość</th>
          <th class="cart-th"></th>
        </tr>
      </thead>
      <tbody id="setList"></tbody>
    </table>
    <button class="send-order" onclick="confirmSet()">Zatwierdź zestaw</button>
  </div>
</div>

<!-- SYNC OVERLAY -->
<div id="syncOverlay">
  <div id="syncBox">
    <div id="syncTitle">Synchronizacja...</div>
    <div id="syncText">Trwa pobieranie danych</div>
    <div id="syncStep">Krok 1/3</div>
  </div>
</div>

<!-- TOAST -->
<div class="toast-wrap" id="toastWrap">
  <div class="toast" id="toastMsg"></div>
</div>

<!-- ALERT -->
<div class="alert-wrap" id="alertWrap">
  <div class="alert-box">
    <div class="alert-title" id="alertTitle">Uwaga</div>
    <div class="alert-msg" id="alertMsg">Treść alertu</div>
    <button class="alert-btn" onclick="closeAlert()">OK</button>
  </div>
</div>

<!-- Ukryty trigger do wymuszania klawiatury -->
<div id="keyboardTrigger" contenteditable="true"></div>

<script>
const SHEET_URL = 'https://script.google.com/macros/s/AKfycbxjCZ2vjKiEEjzR5CqCJSlGIwTk0PdLuDCu1B6c2xwmCFXX2_6mzvCEBW0GiMuIgYIx/exec';

const $=id=>document.getElementById(id);
let userData={handlowcy:[],produkty:[],zestawy:[]};
let currentUser=null;
let currentTab='produkty';
let cart=[];
let calcProduct=null;
let calcValue=0;
let setWorking=null;
let lastInputTime=0;
let lastInputValue='';
let scannerMode=false; // false = klawiatura, true = czytnik
let html5QrCode = null; // Instancja skanera kamery

// FUNKCJE POMOCNICZE
function toast(msg,duration=2500){
  const w=$('toastWrap'),t=$('toastMsg');
  t.textContent=msg;
  w.style.display='block';
  setTimeout(()=>w.style.display='none',duration);
}

function alertBox(title,msg){
  $('alertTitle').textContent=title;
  $('alertMsg').textContent=msg;
  $('alertWrap').style.display='flex';
}

function closeAlert(){
  $('alertWrap').style.display='none';
}

function showSync(){
  $('syncOverlay').style.display='flex';
  $('syncTitle').textContent='Synchronizacja...';
  $('syncText').textContent='Trwa pobieranie danych';
  $('syncStep').textContent='Krok 1/3';
  fetchData();
}

function hideSync(){
  $('syncOverlay').style.display='none';
}

// LOGOWANIE
async function fetchData(){
  try{
    $('syncStep').textContent='Pobieranie handlowców...';
    const res=await fetch(SHEET_URL+'?sheet=Handlowcy');
    const data=await res.json();
    userData.handlowcy=data.data||[];
    
    $('syncStep').textContent='Pobieranie produktów...';
    const res2=await fetch(SHEET_URL+'?sheet=Produkty');
    const data2=await res2.json();
    userData.produkty=data2.data||[];
    
    $('syncStep').textContent='Pobieranie zestawów...';
    const res3=await fetch(SHEET_URL+'?sheet=Zestawy');
    const data3=await res3.json();
    userData.zestawy=data3.data||[];
    
    populateUsers();
    hideSync();
    $('syncBadge').style.display='none';
    toast('✅ Dane zaktualizowane');
  } catch(e){
    hideSync();
    alertBox('Błąd','Nie udało się pobrać danych. Sprawdź połączenie.');
  }
}

function populateUsers(){
  const sel=$('userSelect');
  sel.innerHTML='<option value="">Wybierz handlowca...</option>';
  userData.handlowcy.forEach(h=>{
    const opt=document.createElement('option');
    opt.value=h.email;
    opt.textContent=h.nazwa;
    sel.appendChild(opt);
  });
}

function login(){
  const email=$('userSelect').value;
  if(!email){alertBox('Uwaga','Wybierz handlowca');return;}
  const user=userData.handlowcy.find(h=>h.email===email);
  if(!user){alertBox('Błąd','Nie znaleziono użytkownika');return;}
  currentUser=user;
  $('userInitials').textContent=(user.nazwa||'??').split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
  $('loginScreen').style.display='none';
  $('app').style.display='block';
  renderCurrentTab();
  toast('Witaj '+user.nazwa.split(' ')[0]+'! 👋');
}

function logout(){
  if(!confirm('Czy na pewno chcesz się wylogować?'))return;
  currentUser=null;
  cart=[];
  $('app').style.display='none';
  $('loginScreen').style.display='flex';
}

// WYSZUKIWARKA + DETEKCJA CZYTNIKA
$('searchInput').addEventListener('input',e=>{
  const now=Date.now();
  const val=e.target.value;
  
  // Detekcja czytnika: 13 cyfr w <500ms
  if(!scannerMode && val.length===13 && /^\d{13}$/.test(val) && (now-lastInputTime)<500){
    scannerMode=true;
    updateModeButton();
    toast('📷 Wykryto czytnik kodów');
    handleEanInput(val);
    return;
  }
  
  lastInputTime=now;
  lastInputValue=val;
  
  if(currentTab==='produkty') renderProducts();
});

// NOWA FUNKCJA: PRZEŁĄCZNIK TRYBU
function toggleScannerMode(){
  scannerMode=!scannerMode;
  updateModeButton();
  
  const input=$('searchInput');
  
  if(scannerMode){
    // TRYB CZYTNIKA
    input.inputMode='none';
    input.blur();
    toast('📊 Tryb czytnika EAN');
  } else {
    // TRYB KLAWIATURY - WYMUSZAMY POKAZANIE
    input.inputMode='text';
    forceShowKeyboard();
    toast('⌨️ Tryb klawiatury');
  }
}

function updateModeButton(){
  const btn=$('toggleModeBtn');
  if(scannerMode){
    btn.textContent='barcode';
    btn.classList.add('mode-scanner');
    btn.title='Tryb czytnika (kliknij aby wrócić do klawiatury)';
  } else {
    btn.textContent='keyboard';
    btn.classList.remove('mode-scanner');
    btn.title='Tryb klawiatury (kliknij aby przełączyć na czytnik)';
  }
}

// WYMUSZENIE KLAWIATURY - 3 METODY
function forceShowKeyboard(){
  const input=$('searchInput');
  const trigger=$('keyboardTrigger');
  
  // METODA 1: Blur + Focus + Click
  input.blur();
  input.setAttribute('readonly','readonly');
  
  setTimeout(()=>{
    input.removeAttribute('readonly');
    input.focus();
    input.click();
    
    // Scroll do góry żeby widać było pole
    window.scrollTo({top:0,behavior:'smooth'});
    
    // METODA 2 (fallback): Trigger contenteditable
    setTimeout(()=>{
      if(document.activeElement!==input){
        trigger.focus();
        setTimeout(()=>input.focus(),100);
      }
    },150);
  },100);
}

// WYCZYŚĆ WYSZUKIWARKĘ
function clearSearch(){
  $('searchInput').value='';
  $('searchInput').focus();
  if(currentTab==='produkty') renderProducts();
}

// OBSŁUGA WPISANEGO EAN
function handleEanInput(ean){
  const prod=userData.produkty.find(p=>p.ean===ean);
  if(prod){
    openCalc(prod);
    $('searchInput').value='';
  } else {
    alertBox('Nie znaleziono','Produkt o kodzie EAN '+ean+' nie istnieje w bazie.');
    $('searchInput').value='';
  }
}

// APARAT - OTWÓRZ
function openCamera(){
  const overlay=$('cameraOverlay');
  overlay.style.display='flex';
  
  if(!html5QrCode){
    html5QrCode=new Html5Qrcode("reader");
  }
  
  html5QrCode.start(
    {facingMode:"environment"},
    {
      fps:10,
      qrbox:{width:280,height:280},
      aspectRatio:1.0
    },
    (decodedText)=>{
      // Kod zeskanowany!
      html5QrCode.stop();
      closeCamera();
      
      // Sprawdź czy to EAN (13 cyfr)
      if(/^\d{13}$/.test(decodedText)){
        handleEanInput(decodedText);
      } else {
        alertBox('Błąd','Zeskanowany kod nie jest kodem EAN-13');
      }
    },
    (error)=>{
      // Błąd skanowania (ignorujemy, to normalne podczas skanowania)
    }
  ).catch(err=>{
    alertBox('Błąd kamery','Nie udało się uruchomić kamery. Sprawdź uprawnienia.');
    closeCamera();
  });
}

// APARAT - ZAMKNIJ
function closeCamera(){
  if(html5QrCode){
    html5QrCode.stop().catch(()=>{});
  }
  $('cameraOverlay').style.display='none';
}

// RENDEROWANIE
function renderCurrentTab(){
  if(currentTab==='produkty') renderProducts();
  else if(currentTab==='zestawy') renderSets();
  else if(currentTab==='koszyk') renderCart();
  else if(currentTab==='statystyki') renderStats();
  else if(currentTab==='historia') renderHistory();
}

function renderProducts(){
  const q=$('searchInput').value.toLowerCase().trim();
  let filtered=userData.produkty;
  if(q){
    filtered=filtered.filter(p=>
      (p.symbol||'').toLowerCase().includes(q)||
      (p.nazwa||'').toLowerCase().includes(q)||
      (p.ean||'').includes(q)
    );
  }
  const html=filtered.map(p=>`
    <div class="product">
      <div class="product-left">
        <img src="${p.zdjecie||'https://via.placeholder.com/60'}" class="product-thumb" alt="">
        <div class="product-info">
          <div class="name">${p.nazwa||'Brak nazwy'}</div>
          <div class="codes">${p.symbol||'---'} · EAN: ${p.ean||'---'}</div>
        </div>
      </div>
      <div class="actions">
        <button class="add-btn ${p.nowka==='TAK'?'orange':''}" onclick='openCalc(${JSON.stringify(p).replace(/'/g,"&apos;")})'>+</button>
      </div>
    </div>
  `).join('');
  $('productList').innerHTML=html||'<div class="empty-state"><div class="icon material-symbols-rounded">search_off</div><p>Brak produktów</p></div>';
}

function renderSets(){
  const html=userData.zestawy.map(s=>`
    <div class="product">
      <div class="product-left">
        <div class="product-thumb" style="background:#e0f2fe;display:flex;align-items:center;justify-content:center;font-size:28px;color:#0284c7">📦</div>
        <div class="product-info">
          <div class="name">${s.nazwa||'Zestaw'}</div>
          <div class="codes">${s.items?.length||0} produktów</div>
        </div>
      </div>
      <div class="actions">
        <button class="add-btn" style="background:#0284c7" onclick='openSet(${JSON.stringify(s).replace(/'/g,"&apos;")})'>▶</button>
      </div>
    </div>
  `).join('');
  $('productList').innerHTML=html||'<div class="empty-state"><div class="icon material-symbols-rounded">inventory_2</div><p>Brak zestawów</p></div>';
}

function renderCart(){
  updateCartBadge();
  if(!cart.length){
    $('productList').innerHTML=`
      <div style="background:#fff;border-radius:16px;padding:24px;margin:20px 12px">
        <div class="cart-title">Koszyk</div>
        <div class="empty-state"><div class="icon material-symbols-rounded">shopping_cart</div><p>Koszyk jest pusty</p></div>
      </div>
    `;
    return;
  }
  
  const total=cart.reduce((sum,it)=>sum+it.ilosc,0);
  const html=`
    <div style="background:#fff;border-radius:16px;padding:18px;margin:12px">
      <div class="cart-title">Koszyk (${total} szt)</div>
      <table class="cart-table">
        <thead>
          <tr>
            <th class="cart-th">Lp</th>
            <th class="cart-th">Produkt</th>
            <th class="cart-th">Ilość</th>
            <th class="cart-th"></th>
          </tr>
        </thead>
        <tbody>
          ${cart.map((it,i)=>`
            <tr class="cart-row">
              <td>${i+1}.</td>
              <td class="symname">
                <div style="font-weight:900">${it.nazwa||''}</div>
                <div class="codes">${it.symbol||''}</div>
              </td>
              <td>
                <div class="qty-wrap">
                  <button onclick="changeCartQty(${i},-1)">−</button>
                  <input type="number" min="0" value="${it.ilosc}" onchange="setCartQty(${i},this.value)">
                  <button onclick="changeCartQty(${i},1)">+</button>
                </div>
              </td>
              <td><button class="cart-del" onclick="removeFromCart(${i})">✕</button></td>
            </tr>
          `).join('')}
        </tbody>
      </table>
      
      <div class="order-section">
        <label>Adres dostawy</label>
        <input type="text" id="orderAddress" placeholder="np. Sklep Centrum, ul. Główna 1">
      </div>
      
      <div class="order-section">
        <label>Termin dostawy</label>
        <input type="date" id="orderDate">
      </div>
      
      <div class="order-section">
        <label>Uwagi / Promocje</label>
        <textarea id="orderPromo" placeholder="Dodatkowe informacje, kody promocyjne..."></textarea>
      </div>
      
      <button class="send-order" onclick="sendOrder()">
        <span style="display:inline-flex;align-items:center;gap:8px">
          <span class="material-symbols-rounded">send</span>
          Wyślij zamówienie
        </span>
      </button>
    </div>
  `;
  $('productList').innerHTML=html;
}

function renderStats(){
  const total=cart.reduce((sum,it)=>sum+it.ilosc,0);
  const unique=cart.length;
  
  $('productList').innerHTML=`
    <div style="background:#fff;border-radius:16px;padding:20px;margin:20px 12px">
      <div class="cart-title">Statystyki</div>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value">${unique}</div>
          <div class="stat-label">Pozycje w koszyku</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${total}</div>
          <div class="stat-label">Suma sztuk</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${userData.produkty.length}</div>
          <div class="stat-label">Produkty w bazie</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${userData.zestawy.length}</div>
          <div class="stat-value">Zestawy</div>
        </div>
      </div>
    </div>
  `;
}

function renderHistory(){
  $('productList').innerHTML=`
    <div style="padding:20px 12px">
      <div class="empty-state">
        <div class="icon material-symbols-rounded">history</div>
        <p>Historia zamówień pojawi się wkrótce</p>
      </div>
    </div>
  `;
}

// KALKULATOR
function openCalc(prod){
  calcProduct=prod;
  calcValue=0;
  $('calcProductName').textContent=prod.nazwa||'Produkt';
  $('calcProductCode').textContent='Symbol: '+(prod.symbol||'---')+' · EAN: '+(prod.ean||'---');
  
  const opk=parseInt(prod.opk)||1;
  const btns=[opk,opk*2,opk*3].filter((v,i,a)=>a.indexOf(v)===i);
  $('quickBtns').innerHTML=btns.map(v=>`
    <div class="q-item q2" onclick="calcBtn(${v})">
      <div class="qv">${v}</div>
      <div class="ql">szt</div>
    </div>
  `).join('');
  
  updateCalcDisplay();
  $('calcOverlay').style.display='flex';
}

function closeCalc(){
  $('calcOverlay').style.display='none';
  calcProduct=null;
  calcValue=0;
}

function calcBtn(v){
  if(v==='C'){calcValue=0}
  else if(v==='back'){calcValue=Math.floor(calcValue/10)}
  else{calcValue=calcValue*10+parseInt(v)}
  updateCalcDisplay();
}

function updateCalcDisplay(){
  $('calcDisplay').innerHTML=calcValue+'<sub> szt</sub>';
  const btn=$('calcAddBtn');
  if(calcValue>0){
    btn.classList.add('enabled');
    btn.disabled=false;
  } else {
    btn.classList.remove('enabled');
    btn.disabled=true;
  }
}

function confirmCalc(){
  if(calcValue<=0)return;
  addToCart(calcProduct,calcValue);
  closeCalc();
  toast('Dodano '+calcValue+' szt do koszyka');
}

// KOSZYK
function addToCart(prod,qty){
  const existing=cart.find(it=>it.symbol===prod.symbol);
  if(existing){
    existing.ilosc+=qty;
  } else {
    cart.push({
      symbol:prod.symbol,
      ean:prod.ean,
      nazwa:prod.nazwa,
      ilosc:qty
    });
  }
  updateCartBadge();
}

function changeCartQty(idx,delta){
  if(!cart[idx])return;
  cart[idx].ilosc=Math.max(0,cart[idx].ilosc+delta);
  if(cart[idx].ilosc===0) cart.splice(idx,1);
  renderCart();
}

function setCartQty(idx,val){
  if(!cart[idx])return;
  const n=parseInt(val)||0;
  if(n<=0){cart.splice(idx,1)}
  else{cart[idx].ilosc=n}
  renderCart();
}

function removeFromCart(idx){
  cart.splice(idx,1);
  renderCart();
}

function updateCartBadge(){
  const badge=$('cartBadge');
  const total=cart.reduce((sum,it)=>sum+it.ilosc,0);
  if(total>0){
    badge.textContent=total>99?'99+':total;
    badge.style.display='flex';
  } else {
    badge.style.display='none';
  }
}

// WYSYŁKA ZAMÓWIENIA
async function sendOrder(){
  if(!cart.length){alertBox('Uwaga','Koszyk jest pusty');return;}
  
  const addr=$('orderAddress').value.trim();
  const date=$('orderDate').value;
  const promo=$('orderPromo').value.trim();
  
  if(!addr){alertBox('Uwaga','Podaj adres dostawy');return;}
  if(!date){alertBox('Uwaga','Wybierz termin dostawy');return;}
  
  const order={
    handlowiec:currentUser.nazwa,
    email:currentUser.email,
    data:new Date().toISOString(),
    adres:addr,
    termin:date,
    uwagi:promo,
    pozycje:cart.map(it=>`${it.symbol} - ${it.nazwa} (${it.ilosc} szt)`).join('\n')
  };
  
  showSync();
  $('syncTitle').textContent='Wysyłanie zamówienia...';
  $('syncText').textContent='Proszę czekać';
  
  try{
    const res=await fetch(SHEET_URL,{
      method:'POST',
      body:JSON.stringify(order)
    });
    const data=await res.json();
    hideSync();
    
    if(data.status==='success'){
      cart=[];
      updateCartBadge();
      alertBox('Sukces!','Zamówienie zostało wysłane');
      activateTab(document.querySelector('[data-tab=produkty]'));
    } else {
      alertBox('Błąd','Nie udało się wysłać zamówienia');
    }
  } catch(e){
    hideSync();
    alertBox('Błąd','Problem z połączeniem. Spróbuj ponownie.');
  }
}

// ZESTAWY
function openSet(set){
  setWorking=JSON.parse(JSON.stringify(set));
  renderSetPopup();
  $('setOverlay').style.display='flex';
}

function closeSet(){
  $('setOverlay').style.display='none';
  setWorking=null;
}

function expandSet(s,multiplier=1,visited=new Set()){
  if(visited.has(s.symbol))return[];
  visited.add(s.symbol);
  const out=[];
  for(const item of (s.items||[])){
    const sym=item.symbol;
    const qty=(item.ilosc||0)*multiplier;
    const nested=userData.zestawy.find(z=>z.symbol===sym);
    if(nested){
      out.push(...expandSet(nested,qty||1,new Set(visited)));
    } else {
      out.push({symbol:sym,ilosc:qty});
    }
  }
  return out;
}

function renderSetPopup(){
  $('setTitle').textContent=setWorking?.nazwa||'Zestaw';
  const gratisBox=$('setGratis');
  if(setWorking?.gratis && String(setWorking.gratis).trim()){
    gratisBox.style.display='block';
    gratisBox.textContent=String(setWorking.gratis).trim();
  } else {
    gratisBox.style.display='none';
  }
  $('setComment').textContent=setWorking?.komentarz||'';

  const body=$('setList');body.innerHTML='';
  if(!setWorking||!setWorking.items?.length){
    body.innerHTML='<tr class="cart-row"><td colspan="4" style="text-align:center;padding:12px;opacity:.7">Brak pozycji</td></tr>';
    return;
  }
  setWorking.items.forEach((it,idx)=>{
    const tr=document.createElement('tr');tr.className='cart-row';
    const lp=document.createElement('td');lp.textContent=String(idx+1)+'.';
    const symname=document.createElement('td');symname.className='symname';symname.innerHTML=`<div style="font-weight:900">${it.nazwa||''}</div><div class="codes">${it.symbol||''}</div>`;
    const qty=document.createElement('td');qty.innerHTML='';
    const wrap=document.createElement('div');wrap.className='qty-wrap';
    const minus=document.createElement('button');minus.textContent='−';minus.onclick=()=>{changeSetQty(idx,-it.min);};
    const input=document.createElement('input');input.type='number';input.min=0;input.step=it.min;input.value=it.ilosc;input.onchange=()=>setSetQty(idx,parseInt(input.value,10)||0);
    const plus=document.createElement('button');plus.textContent='+';plus.onclick=()=>{changeSetQty(idx,it.min);};
    wrap.append(minus,input,plus);qty.append(wrap);
    const del=document.createElement('td');const delBtn=document.createElement('button');delBtn.className='cart-del';delBtn.textContent='✕';delBtn.onclick=()=>removeSetItem(idx);del.append(delBtn);
    tr.append(lp,symname,qty,del);
    body.append(tr);
  });
}

function changeSetQty(idx,delta){
  if(!setWorking?.items[idx])return;
  const it=setWorking.items[idx];
  const next=Math.max(0,(it.ilosc||0)+delta);
  if(next>0 && next%it.min!==0){alertBox('Uwaga',`Produkt ${it.symbol} musi być wielokrotnością ${it.min}`);return;}
  it.ilosc=next;renderSetPopup();
}

function setSetQty(idx,val){
  if(!setWorking?.items[idx])return;
  const it=setWorking.items[idx];
  if(val>0 && val%it.min!==0){alertBox('Uwaga',`Produkt ${it.symbol} musi być wielokrotnością ${it.min}`);renderSetPopup();return;}
  it.ilosc=Math.max(0,val);renderSetPopup();
}

function removeSetItem(idx){
  if(!setWorking?.items[idx])return;
  setWorking.items.splice(idx,1);renderSetPopup();
}

function confirmSet(){
  if(!setWorking)return;
  const selected=setWorking.items.filter(x=>Number(x.ilosc)>0);
  if(!selected.length){alertBox('Uwaga','Wprowadź ilość dla przynajmniej jednego produktu.');return;}
  selected.forEach(x=>{
    addToCart({symbol:x.symbol,ean:'',nazwa:x.nazwa},x.ilosc);
  });
  const promoEl=$('orderPromo');
  const lines=[];
  if(setWorking.komentarz && String(setWorking.komentarz).trim())lines.push(String(setWorking.komentarz).trim());
  if(setWorking.gratis && String(setWorking.gratis).trim())lines.unshift(String(setWorking.gratis).trim());
  const append=lines.join(' | ');
  if(append){
    const cur=promoEl.value.trim();
    promoEl.value=cur?(append+' | '+cur):append;
  }
  closeSet();
  toast('Zestaw dodany (do koszyka i komentarza)');
}

function activateTab(el){
  document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));
  el.classList.add('active');
  currentTab=el.getAttribute('data-tab')||'produkty';
  renderCurrentTab();
}

(function initBottomNavAutoHide(){
  const nav=$('bottomNav');
  let lastY=window.scrollY,ticking=false;
  function onScroll(){
    const y=window.scrollY;
    const down=y>lastY;
    if(down && y>20)nav.classList.add('hide');
    else nav.classList.remove('hide');
    lastY=y;
    ticking=false;
  }
  window.addEventListener('scroll',()=>{
    if(!ticking){
      window.requestAnimationFrame(onScroll);
      ticking=true;
    }
  },{passive:true});
})();

// Rejestracja Service Workera
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('/service-worker.js')
      .then(registration=>{
        console.log('✅ Service Worker zarejestrowany:',registration.scope);
      })
      .catch(error=>{
        console.log('❌ Błąd rejestracji SW:',error);
      });
  });
}

// AUTO-START
fetchData();
</script>
</body>
</html>
